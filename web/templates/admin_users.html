{{define "content"}}
{{template "flash_messages" .}}

<!-- Create User Modal -->
<div id="create-user-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeCreateUserModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Create New User</h3>
				<button onclick="closeCreateUserModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form method="POST" action="/admin/users/create">
				<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
				
				<div class="mb-4">
					<label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
					<input type="text" id="username" name="username" required
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
				</div>

				<div class="mb-4">
					<label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
					<input type="email" id="email" name="email" required
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
				</div>

				<div class="mb-4">
					<label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Password</label>
					<input type="password" id="password" name="password" required minlength="8"
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
					<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Must be at least 8 characters. User can change this after logging in.</p>
				</div>

				<div class="mb-6">
					<label class="flex items-center gap-2 cursor-pointer">
						<input type="checkbox" name="is_admin" class="w-4 h-4 text-gray-900 dark:text-gray-100 rounded border-gray-300 dark:border-gray-600 focus:ring-gray-900 dark:focus:ring-gray-400">
						<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Make this user an admin</span>
					</label>
				</div>

				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeCreateUserModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Create User</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Reset Password Modal -->
<div id="reset-password-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeResetPasswordModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Reset Password</h3>
				<button onclick="closeResetPasswordModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form id="reset-password-form" method="POST" action="">
				<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
				<p id="reset-password-username" class="text-sm text-gray-600 dark:text-gray-400 mb-4"></p>
				
				<div class="mb-6">
					<label for="new_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Password</label>
					<input type="password" id="new_password" name="new_password" required minlength="8"
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
					<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Must be at least 8 characters</p>
				</div>

				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeResetPasswordModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Reset Password</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Update Quota Modal -->
<div id="update-quota-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeUpdateQuotaModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Update Storage Quota</h3>
				<button onclick="closeUpdateQuotaModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form id="update-quota-form" method="POST" action="">
				<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
				<p id="update-quota-username" class="text-sm text-gray-600 dark:text-gray-400 mb-4"></p>
				
				<div class="mb-6">
					<label for="quota" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quota (in bytes)</label>
					<input type="number" id="quota" name="quota" required min="0"
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
					<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
						Presets: 
						<button type="button" onclick="setQuota(1073741824)" class="text-blue-600 dark:text-blue-400 hover:underline">1 GB</button> |
						<button type="button" onclick="setQuota(5368709120)" class="text-blue-600 dark:text-blue-400 hover:underline">5 GB</button> |
						<button type="button" onclick="setQuota(10737418240)" class="text-blue-600 dark:text-blue-400 hover:underline">10 GB</button> |
						<button type="button" onclick="setQuota(53687091200)" class="text-blue-600 dark:text-blue-400 hover:underline">50 GB</button> |
						<button type="button" onclick="setQuota(107374182400)" class="text-blue-600 dark:text-blue-400 hover:underline">100 GB</button>
					</p>
				</div>

				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeUpdateQuotaModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Update Quota</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="min-h-[calc(100vh-80px)] bg-white dark:bg-gray-800">
	<main class="p-6 max-w-7xl mx-auto">
		<div class="flex items-center justify-between mb-6">
			<div class="flex items-center gap-4">
				<a href="/admin" class="flex items-center justify-center w-8 h-8 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-600 dark:text-gray-400" title="Back to Dashboard">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<polyline points="15 18 9 12 15 6"></polyline>
					</svg>
				</a>
				<h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">User Management</h1>
			</div>
			<button onclick="openCreateUserModal()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-900 dark:bg-gray-600 text-white hover:bg-gray-700 dark:hover:bg-gray-500 transition-colors font-medium">
				<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
					<circle cx="8.5" cy="7" r="4"></circle>
					<line x1="20" y1="8" x2="20" y2="14"></line>
					<line x1="23" y1="11" x2="17" y2="11"></line>
				</svg>
				Add User
			</button>
		</div>

		<!-- Users Table -->
		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
			{{if .Users}}
			<div class="overflow-x-auto">
				<table class="w-full border-collapse">
					<thead>
						<tr class="bg-gray-50 dark:bg-gray-700">
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">User</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Role</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Files</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Storage</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Created</th>
							<th class="text-right p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Actions</th>
						</tr>
					</thead>
					<tbody>
						{{range .Users}}
						<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
							<td class="p-4 border-b border-gray-200 dark:border-gray-700">
								<div class="font-medium text-gray-900 dark:text-gray-100">{{.Username}}</div>
								<div class="text-sm text-gray-500 dark:text-gray-400">{{.Email}}</div>
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700">
								{{if .IsAdmin}}
								<span class="px-2 py-1 text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full">Admin</span>
								{{else}}
								<span class="px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full">User</span>
								{{end}}
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">{{.FileCount}}</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">
								{{formatBytes .StorageUsed}} / {{formatBytes .StorageQuota}}
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">
								{{.CreatedAt.Format "2006-01-02"}}
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-right">
								<div class="flex items-center justify-end gap-2">
									<!-- Toggle Admin -->
									{{if ne .ID $.User.ID}}
									<form method="POST" action="/admin/users/{{.ID}}/toggle-admin" class="inline">
										<input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
										<button type="submit" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="{{if .IsAdmin}}Remove Admin{{else}}Make Admin{{end}}">
											{{if .IsAdmin}}
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600 dark:text-purple-400" aria-hidden="true">
												<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
												<polyline points="9 12 12 15 16 10"></polyline>
											</svg>
											{{else}}
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true">
												<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
											</svg>
											{{end}}
										</button>
									</form>
									{{else}}
									<span class="p-2 opacity-40 cursor-not-allowed" title="Cannot modify your own admin status">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600 dark:text-purple-400" aria-hidden="true">
											<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
											<polyline points="9 12 12 15 16 10"></polyline>
										</svg>
									</span>
									{{end}}

									<!-- Update Quota -->
									<button onclick="openUpdateQuotaModal({{.ID}}, '{{.Username}}', {{.StorageQuota}})" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Update Quota">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-400" aria-hidden="true">
											<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
											<path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
											<path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
										</svg>
									</button>

									<!-- Reset Password -->
									<button onclick="openResetPasswordModal({{.ID}}, '{{.Username}}')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Reset Password">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-400" aria-hidden="true">
											<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
											<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
										</svg>
									</button>

									<!-- Delete User -->
									{{if ne .ID $.User.ID}}
									<form method="POST" action="/admin/users/{{.ID}}/delete" id="delete-form-{{.ID}}" class="inline">
										<input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
										<button type="button" onclick="confirmDeleteUser({{.ID}}, '{{.Username}}', {{.FileCount}}, '{{formatBytes .StorageUsed}}')" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors" title="Delete User">
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600 dark:text-red-400" aria-hidden="true">
												<polyline points="3 6 5 6 21 6"></polyline>
												<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
											</svg>
										</button>
									</form>
									{{else}}
									<span class="p-2 opacity-40 cursor-not-allowed" title="Cannot delete your own account">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true">
											<polyline points="3 6 5 6 21 6"></polyline>
											<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
										</svg>
									</span>
									{{end}}
								</div>
							</td>
						</tr>
						{{end}}
					</tbody>
				</table>
			</div>
			{{else}}
			<div class="p-8 text-center text-gray-600 dark:text-gray-400">
				<p>No users found.</p>
			</div>
			{{end}}
		</div>
	</main>
</div>

<script>
	// Create User Modal
	function openCreateUserModal() {
		document.getElementById('create-user-modal').classList.remove('hidden');
		document.getElementById('username').focus();
	}
	
	function closeCreateUserModal() {
		document.getElementById('create-user-modal').classList.add('hidden');
		document.getElementById('username').value = '';
		document.getElementById('email').value = '';
		document.getElementById('password').value = '';
	}

	// Reset Password Modal
	function openResetPasswordModal(userId, username) {
		document.getElementById('reset-password-form').action = '/admin/users/' + userId + '/reset-password';
		document.getElementById('reset-password-username').textContent = 'Reset password for: ' + username;
		document.getElementById('reset-password-modal').classList.remove('hidden');
		document.getElementById('new_password').focus();
	}
	
	function closeResetPasswordModal() {
		document.getElementById('reset-password-modal').classList.add('hidden');
		document.getElementById('new_password').value = '';
	}

	// Update Quota Modal
	function openUpdateQuotaModal(userId, username, currentQuota) {
		document.getElementById('update-quota-form').action = '/admin/users/' + userId + '/quota';
		document.getElementById('update-quota-username').textContent = 'Update quota for: ' + username;
		document.getElementById('quota').value = currentQuota;
		document.getElementById('update-quota-modal').classList.remove('hidden');
		document.getElementById('quota').focus();
	}
	
	function closeUpdateQuotaModal() {
		document.getElementById('update-quota-modal').classList.add('hidden');
	}

	function setQuota(bytes) {
		document.getElementById('quota').value = bytes;
	}

	// Delete User Confirmation
	function confirmDeleteUser(userId, username, fileCount, storageUsed) {
		let message = `Are you sure you want to delete user "${username}"?\n\n`;
		
		if (fileCount > 0) {
			message += `This will permanently delete:\n`;
			message += `• ${fileCount} file${fileCount !== 1 ? 's' : ''}\n`;
			message += `• ${storageUsed} of storage\n\n`;
			
			if (fileCount > 100) {
				message += `⚠️ WARNING: This user has many files. File deletion will happen in the background and may take some time to complete.\n\n`;
			}
		} else {
			message += `This user has no files.\n\n`;
		}
		
		message += `This action cannot be undone.`;
		
		if (confirm(message)) {
			document.getElementById('delete-form-' + userId).submit();
		}
	}

	// Close modals on Escape key
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			closeCreateUserModal();
			closeResetPasswordModal();
			closeUpdateQuotaModal();
		}
	});
</script>
{{end}}
