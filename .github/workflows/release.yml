name: Release Binaries

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: production
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run tests
        run: go test -v ./...

      - name: Install Tailwind CSS CLI (amd64)
        run: |
          curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-linux-x64
          chmod +x tailwindcss-linux-x64
          ./tailwindcss-linux-x64 \
            -i ./web/static/css/input.css \
            -o ./web/static/css/style.css \
            --minify

      - name: Build binaries
        run: |
          # Build for Linux amd64
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
            -o trove-linux-amd64 \
            ./cmd/server
          
          # Build for Linux arm64
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
            -o trove-linux-arm64 \
            ./cmd/server
          
          # Build for macOS amd64
          GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
            -o trove-darwin-amd64 \
            ./cmd/server
          
          # Build for macOS arm64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
            -o trove-darwin-arm64 \
            ./cmd/server
          
          # Build for Windows amd64
          GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags="-s -w -X main.Version=${{ github.ref_name }}" \
            -o trove-windows-amd64.exe \
            ./cmd/server

      - name: Create checksums
        run: |
          sha256sum trove-* > checksums.txt

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit SHA
        id: get_sha
        run: echo "sha=sha-$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      - name: Pull existing Docker image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_sha.outputs.sha }}

      - name: Extract version tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Re-tag and push Docker image
        run: |
          SOURCE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_sha.outputs.sha }}"
          
          # Read all tags and re-tag the image
          echo "${{ steps.meta.outputs.tags }}" | while read -r tag; do
            if [ -n "$tag" ]; then
              echo "Tagging $SOURCE_IMAGE as $tag"
              docker buildx imagetools create --tag "$tag" "$SOURCE_IMAGE"
            fi
          done

      - name: Extract version numbers
        id: version
        run: |
          # Extract version from tag (e.g., v0.1.0)
          VERSION="${{ github.ref_name }}"
          # Remove 'v' prefix for processing
          VERSION_NUM="${VERSION#v}"
          # Full version without v prefix (for Docker tags)
          echo "full=$VERSION_NUM" >> $GITHUB_OUTPUT
          # Extract major version (e.g., 0)
          MAJOR="$(echo "$VERSION_NUM" | cut -d. -f1)"
          # Extract minor version (e.g., 0.1)
          MINOR="$(echo "$VERSION_NUM" | cut -d. -f1,2)"
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            trove-linux-amd64
            trove-linux-arm64
            trove-darwin-amd64
            trove-darwin-arm64
            trove-windows-amd64.exe
            checksums.txt
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üê≥ Docker Images
            
            Pull this release:
            ```bash
            docker pull ghcr.io/agjmills/trove:${{ steps.version.outputs.full }}
            ```
            
            Available tags:
            - `ghcr.io/agjmills/trove:${{ steps.version.outputs.full }}` - Full version
            - `ghcr.io/agjmills/trove:${{ steps.version.outputs.minor }}` - Minor version
            - `ghcr.io/agjmills/trove:${{ steps.version.outputs.major }}` - Major version
            
            ## üì¶ Installation
            
            Download the appropriate binary for your system from the Assets section below, then:
            
            ```bash
            # Make it executable
            chmod +x trove-*
            
            # Verify checksum
            sha256sum -c checksums.txt
            
            # Run
            ./trove-linux-amd64
            ```
