{{define "content"}}
<!-- Drag and Drop Overlay -->
<div id="drag-overlay" class="drag-overlay" style="display: none;">
	<div class="drag-overlay-content">
		<div class="drag-icon">ğŸ“¤</div>
		<h2>Drop files here to upload</h2>
		<p>Files will be uploaded to the current folder</p>
	</div>
</div>

<div class="dashboard-layout">
	<!-- Sidebar -->
	<aside id="sidebar" class="sidebar">
		<div class="sidebar-header">
			<h3>Storage</h3>
		</div>

		<div class="sidebar-section">
			<div class="storage-info">
				<div class="storage-label">Used</div>
				<div class="storage-value">{{formatBytes .User.StorageUsed}} / {{formatBytes .User.StorageQuota}}</div>
				<div class="storage-bar">
					<div class="storage-bar-fill" style="width: {{div (mul .User.StorageUsed 100) .User.StorageQuota}}%"></div>
				</div>
			</div>
		</div>

		<div class="sidebar-section">
			<h4>Upload File</h4>
			<form method="POST" action="/upload" enctype="multipart/form-data" id="upload-form">
				<input type="hidden" name="folder" value="{{.CurrentFolder}}">
				<input type="hidden" name="csrf_token" value="{{.CSRFToken}}" id="csrf-token">
				<input type="file" name="file" id="file-input" required style="display: none;">
				<button type="button" id="upload-button" class="sidebar-btn" onclick="document.getElementById('file-input').click()">
					ğŸ“¤ Choose File
				</button>
			</form>
		</div>

		<div class="sidebar-section">
			<h4>New Folder</h4>
			<form method="POST" action="/folders/create">
				<input type="hidden" name="current_folder" value="{{.CurrentFolder}}">
				<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
				<input type="text" name="folder_name" placeholder="Folder name" required class="sidebar-input">
				<button type="submit" class="sidebar-btn">ğŸ“ Create</button>
			</form>
		</div>

		<!-- Upload Progress in Sidebar -->
		<div id="upload-progress-container" class="upload-progress-container" style="display: none;">
			<div class="upload-progress-content">
				<div class="upload-progress-text">
					<span id="upload-filename">Uploading...</span>
					<span id="upload-percentage">0%</span>
				</div>
				<div class="upload-progress-bar">
					<div id="upload-progress-fill" class="upload-progress-fill"></div>
				</div>
			</div>
		</div>
	</aside>

	<!-- Main Content -->
	<main class="main-content">
		<h1>Your Files</h1>

		<!-- Flash Messages -->
		{{if .Flash}}
		<div class="flash flash-{{.Flash.Type}}">
			{{.Flash.Content}}
		</div>
		{{end}}

		<!-- Breadcrumb Navigation -->
		<div class="breadcrumbs">
			{{range $index, $crumb := .Breadcrumbs}}
				{{if $index}} / {{end}}
				{{if eq $crumb.Path $.CurrentFolder}}
					<strong>{{$crumb.Name}}</strong>
				{{else}}
					<a href="/dashboard?folder={{$crumb.Path}}">{{$crumb.Name}}</a>
				{{end}}
			{{end}}
		</div>

		{{if or .Files .Folders (ne .CurrentFolder "/")}}
			<table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Size</th>
						<th class="hide-mobile">Uploaded</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
				{{if ne .CurrentFolder "/"}}
				<tr class="parent-directory">
					<td class="filename-cell">
						<a href="/dashboard{{if eq .ParentFolder "/"}}{{else}}?folder={{.ParentFolder}}{{end}}">
							ğŸ“ â†©ï¸ Parent Directory
						</a>
					</td>
					<td>-</td>
					<td class="hide-mobile">-</td>
					<td></td>
				</tr>
				{{end}}
				{{range .Folders}}
				<tr>
					<td class="filename-cell">
						<a href="/dashboard?folder={{if eq $.CurrentFolder "/"}}/{{.}}{{else}}{{$.CurrentFolder}}/{{.}}{{end}}">
							ğŸ“ {{.}}
						</a>
					</td>
					<td>-</td>
					<td class="hide-mobile">-</td>
					<td>
						<form method="POST" action="/folders/delete/{{.}}" style="display:inline">
							<input type="hidden" name="current_folder" value="{{$.CurrentFolder}}">
							<input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
							<button type="submit">Delete</button>
						</form>
					</td>
				</tr>
				{{end}}
				{{range .Files}}
				<tr>
					<td class="filename-cell">{{.OriginalFilename}}</td>
					<td>{{formatBytes .FileSize}}</td>
					<td class="hide-mobile">{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
					<td>
						<button class="download-btn" onclick="window.location='/download/{{.ID}}'">Download</button>
						<form method="POST" action="/delete/{{.ID}}" style="display:inline">
							<input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
							<button type="submit">Delete</button>
						</form>
					</td>
				</tr>
				{{end}}
			</tbody>
		</table>

		<!-- Pagination -->
		{{if gt .TotalPages 1}}
		<div class="pagination">
			{{if gt .Page 1}}
				<a href="/dashboard?folder={{.CurrentFolder}}&page={{.Page | add -1}}" class="pagination-btn">â† Previous</a>
			{{else}}
				<span class="pagination-btn disabled">â† Previous</span>
			{{end}}

			<span class="pagination-info">Page {{.Page}} of {{.TotalPages}}</span>

			{{if lt .Page .TotalPages}}
				<a href="/dashboard?folder={{.CurrentFolder}}&page={{.Page | add 1}}" class="pagination-btn">Next â†’</a>
			{{else}}
				<span class="pagination-btn disabled">Next â†’</span>
			{{end}}
		</div>
		{{end}}
	{{else}}
		<p>No files in this folder yet.</p>
	{{end}}
	</main>
</div>

<script>
	// Sidebar toggle
	const sidebar = document.getElementById('sidebar');
	const sidebarToggle = document.getElementById('sidebar-toggle-nav');
	
	// Initialize sidebar state based on screen size
	function initSidebar() {
		if (window.innerWidth < 900) {
			// Mobile/Portrait: collapsed by default
			sidebar.classList.add('sidebar-collapsed');
		} else {
			// Desktop/Landscape: always visible
			sidebar.classList.remove('sidebar-collapsed');
		}
	}
	
	// Initialize on load
	initSidebar();
	
	// Handle window resize
	window.addEventListener('resize', function() {
		if (window.innerWidth >= 900) {
			// Always show sidebar on desktop/landscape
			sidebar.classList.remove('sidebar-collapsed');
		}
	});
	
	if (sidebarToggle) {
		sidebarToggle.addEventListener('click', function() {
			// Only toggle on mobile/portrait
			if (window.innerWidth < 900) {
				sidebar.classList.toggle('sidebar-collapsed');
			}
		});
	}
	
	// Close sidebar when clicking outside on mobile
	document.addEventListener('click', function(e) {
		if (window.innerWidth < 900 && 
			!sidebar.contains(e.target) && 
			(!sidebarToggle || !sidebarToggle.contains(e.target)) &&
			!sidebar.classList.contains('sidebar-collapsed')) {
			sidebar.classList.add('sidebar-collapsed');
		}
	});

	// Drag and drop functionality
	const dragOverlay = document.getElementById('drag-overlay');
	const uploadForm = document.getElementById('upload-form');
	const fileInput = document.getElementById('file-input');
	const uploadButton = document.getElementById('upload-button');
	const progressContainer = document.getElementById('upload-progress-container');
	const progressFill = document.getElementById('upload-progress-fill');
	const uploadPercentage = document.getElementById('upload-percentage');
	const uploadFilename = document.getElementById('upload-filename');
	let dragCounter = 0;

	// Function to upload file with progress tracking
	function uploadFile(file) {
		const formData = new FormData();
		formData.append('file', file);
		formData.append('folder', uploadForm.querySelector('input[name="folder"]').value);
		formData.append('csrf_token', document.getElementById('csrf-token').value);

		// Show progress bar
		progressContainer.style.display = 'block';
		uploadFilename.textContent = file.name;
		uploadPercentage.textContent = '0%';
		progressFill.style.width = '0%';
		
		// Disable upload button during upload
		uploadButton.disabled = true;

		const xhr = new XMLHttpRequest();

		// Track upload progress
		xhr.upload.addEventListener('progress', function(e) {
			if (e.lengthComputable) {
				const percentage = Math.round((e.loaded / e.total) * 100);
				progressFill.style.width = percentage + '%';
				uploadPercentage.textContent = percentage + '%';
			}
		});

		// Handle completion
		xhr.addEventListener('load', function() {
			if (xhr.status === 200 || xhr.status === 302 || xhr.status === 303) {
				// Success - reload page to show updated file list
				window.location.reload();
			} else {
				// Error
				alert('Upload failed. Please try again.');
				progressContainer.style.display = 'none';
				uploadButton.disabled = false;
			}
		});

		// Handle errors
		xhr.addEventListener('error', function() {
			alert('Upload failed. Please try again.');
			progressContainer.style.display = 'none';
			uploadButton.disabled = false;
		});

		// Send request
		xhr.open('POST', '/upload');
		xhr.send(formData);
	}

	// Prevent default drag behaviors on the entire page
	['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
		document.body.addEventListener(eventName, preventDefaults, false);
	});

	function preventDefaults(e) {
		e.preventDefault();
		e.stopPropagation();
	}

	// Show overlay when dragging files over the window
	document.body.addEventListener('dragenter', function(e) {
		if (e.dataTransfer.types.includes('Files')) {
			dragCounter++;
			dragOverlay.style.display = 'flex';
		}
	});

	document.body.addEventListener('dragleave', function(e) {
		dragCounter--;
		if (dragCounter === 0) {
			dragOverlay.style.display = 'none';
		}
	});

	// Handle file drop
	document.body.addEventListener('drop', function(e) {
		dragCounter = 0;
		dragOverlay.style.display = 'none';
		
		const files = e.dataTransfer.files;
		if (files.length > 0) {
			uploadFile(files[0]);
		}
	});

	// Also hide overlay when dragging over it
	dragOverlay.addEventListener('dragover', function(e) {
		e.preventDefault();
	});

	// Handle file selection via button
	fileInput.addEventListener('change', function() {
		if (this.files.length > 0) {
			uploadFile(this.files[0]);
		}
	});
</script>

{{end}}
