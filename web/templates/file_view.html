{{define "content"}}
<div class="min-h-[calc(100vh-80px)] bg-white dark:bg-gray-800">
	<main class="p-6 max-w-6xl mx-auto">
		<!-- Header with file name and back button -->
		<div class="mb-6 flex items-center gap-4">
			<a href="/files?folder={{.File.LogicalPath}}" class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<polyline points="15 18 9 12 15 6"></polyline>
				</svg>
			</a>
			<h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 truncate flex-1">{{.File.Filename}}</h1>
		</div>

		<!-- Preview area -->
		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden mb-6">
			<div class="p-4 border-b border-gray-200 dark:border-gray-700">
				<h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Preview</h2>
			</div>
			<div id="preview-content" class="p-4 bg-gray-50 dark:bg-gray-900 min-h-[400px] flex items-center justify-center">
				{{if .CanPreview}}
					{{if .IsImage}}
						<img src="/preview/{{.File.ID}}" alt="{{.File.Filename}}" class="max-w-full max-h-[600px] object-contain rounded">
					{{else if .IsPDF}}
						<iframe src="/preview/{{.File.ID}}" class="w-full h-[600px] rounded border-0"></iframe>
					{{else if .IsVideo}}
						<video controls class="max-w-full max-h-[600px] rounded">
							<source src="/preview/{{.File.ID}}" type="{{.File.MimeType}}">
							Your browser does not support the video tag.
						</video>
					{{else if .IsAudio}}
						<audio controls class="w-full max-w-2xl">
							<source src="/preview/{{.File.ID}}" type="{{.File.MimeType}}">
							Your browser does not support the audio tag.
						</audio>
					{{else if .IsText}}
						<div class="w-full">
							<pre id="text-preview" class="text-sm overflow-auto p-4 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 max-h-[600px]"><code class="text-gray-800 dark:text-gray-200">Loading...</code></pre>
						</div>
						<script>
							fetch('/preview/{{.File.ID}}')
								.then(response => response.text())
								.then(text => {
									const displayText = text.length > 100000 ? text.substring(0, 100000) + '\n\n... (truncated, file too large for preview)' : text;
									const codeEl = document.querySelector('#text-preview code');
									codeEl.textContent = displayText;
								})
								.catch(error => {
									const codeEl = document.querySelector('#text-preview code');
									codeEl.textContent = 'Failed to load file content';
									codeEl.classList.add('text-red-600', 'dark:text-red-400');
								});
						</script>
					{{end}}
				{{else}}
					<div class="text-center space-y-4">
						<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 dark:text-gray-600">
							<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
							<polyline points="13 2 13 9 20 9"></polyline>
						</svg>
						<div class="text-gray-600 dark:text-gray-400">
							<p class="font-medium">Preview not available for this file type</p>
							<p class="text-sm mt-2">Use the download button to view this file</p>
						</div>
					</div>
				{{end}}
			</div>
		</div>

		<!-- Bottom row with Actions and File Information side by side on desktop -->
		<div class="flex flex-col lg:flex-row gap-6">
			<!-- Action buttons -->
			<div class="w-full lg:w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
				<h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">Actions</h3>
				<div class="space-y-3">
					<a href="/download/{{.File.ID}}" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-gray-900 dark:bg-gray-600 text-white rounded-lg hover:bg-gray-700 dark:hover:bg-gray-500 transition-colors font-medium">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
							<polyline points="7 10 12 15 17 10"></polyline>
							<line x1="12" y1="15" x2="12" y2="3"></line>
						</svg>
						Download
					</a>
					
					<button type="button" onclick="openRenameDialog()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors font-medium">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
							<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
						</svg>
						Rename
					</button>

					<button type="button" onclick="openMoveDialog()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors font-medium">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
							<polyline points="12 11 12 17"></polyline>
							<polyline points="9 14 12 11 15 14"></polyline>
						</svg>
						Move
					</button>

					<div class="pt-3 border-t border-gray-200 dark:border-gray-700">
						<form method="POST" action="/delete/{{.File.ID}}" onsubmit="return confirm('Are you sure you want to delete this file?');">
							<button type="submit" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white dark:bg-gray-700 text-red-600 dark:text-red-400 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors font-medium">
								<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<polyline points="3 6 5 6 21 6"></polyline>
									<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
								</svg>
								Delete
							</button>
						</form>
					</div>
				</div>
			</div>

			<!-- File information -->
			<div class="w-full lg:w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
				<h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-4 uppercase tracking-wide">File Information</h3>
				<dl class="space-y-4 text-sm">
					<div>
						<dt class="text-gray-600 dark:text-gray-400 font-medium">Original Name</dt>
						<dd class="text-gray-900 dark:text-gray-100 mt-1 break-all">{{.File.OriginalFilename}}</dd>
					</div>
					<div>
						<dt class="text-gray-600 dark:text-gray-400 font-medium">Size</dt>
						<dd class="text-gray-900 dark:text-gray-100 mt-1">{{formatBytes .File.FileSize}}</dd>
					</div>
					<div>
						<dt class="text-gray-600 dark:text-gray-400 font-medium">Type</dt>
						<dd class="text-gray-900 dark:text-gray-100 mt-1 break-all">{{.File.MimeType}}</dd>
					</div>
					<div>
						<dt class="text-gray-600 dark:text-gray-400 font-medium">Uploaded</dt>
						<dd class="text-gray-900 dark:text-gray-100 mt-1">{{.File.CreatedAt.Format "Jan 2, 2006 at 3:04 PM"}}</dd>
					</div>
					<div>
						<dt class="text-gray-600 dark:text-gray-400 font-medium">Modified</dt>
						<dd class="text-gray-900 dark:text-gray-100 mt-1">{{.File.UpdatedAt.Format "Jan 2, 2006 at 3:04 PM"}}</dd>
					</div>
					<div>
						<dt class="text-gray-600 dark:text-gray-400 font-medium">Location</dt>
						<dd class="text-gray-900 dark:text-gray-100 mt-1">{{if eq .File.LogicalPath "/"}}/ (Root){{else}}{{.File.LogicalPath}}{{end}}</dd>
					</div>
					{{if .File.Hash}}
					<div>
						<dt class="text-gray-600 dark:text-gray-400 font-medium">SHA-256</dt>
						<dd class="text-gray-900 dark:text-gray-100 mt-1 font-mono text-xs break-all">{{.File.Hash}}</dd>
					</div>
					{{end}}
				</dl>
			</div>
		</div>
	</main>
</div>

<!-- Rename Modal -->
<div id="rename-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeRenameDialog()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Rename File</h3>
				<button onclick="closeRenameDialog()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form method="POST" action="/rename/{{.File.ID}}">
				<input type="text" name="new_name" id="rename-input" value="{{.File.Filename}}" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm mb-4 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeRenameDialog()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Rename</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Move Modal -->
<div id="move-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeMoveDialog()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Move File</h3>
				<button onclick="closeMoveDialog()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form method="POST" action="/move/{{.File.ID}}">
				<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Destination Folder</label>
				<select name="destination_folder" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm mb-4 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
					<option value="/" {{if eq .File.LogicalPath "/"}}selected{{end}}>/ (Root)</option>
					{{range .AllFolders}}
						<option value="{{.}}" {{if eq $.File.LogicalPath .}}selected{{end}}>{{.}}</option>
					{{end}}
				</select>
				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeMoveDialog()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Move</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
	// Focus trap utility for modal accessibility
	function createFocusTrap(modal) {
		const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
		let firstFocusable = null;
		let lastFocusable = null;

		function updateFocusableElements() {
			const focusableElements = modal.querySelectorAll(focusableSelectors);
			const visible = Array.from(focusableElements).filter(el => {
				return el.offsetParent !== null && !el.disabled;
			});
			firstFocusable = visible[0];
			lastFocusable = visible[visible.length - 1];
		}

		function handleKeydown(e) {
			if (e.key !== 'Tab') return;

			updateFocusableElements();
			if (!firstFocusable || !lastFocusable) return;

			if (e.shiftKey) {
				if (document.activeElement === firstFocusable) {
					e.preventDefault();
					lastFocusable.focus();
				}
			} else {
				if (document.activeElement === lastFocusable) {
					e.preventDefault();
					firstFocusable.focus();
				}
			}
		}

		return {
			activate: function() {
				updateFocusableElements();
				modal.addEventListener('keydown', handleKeydown);
			},
			deactivate: function() {
				modal.removeEventListener('keydown', handleKeydown);
			}
		};
	}

	// Create focus traps for modals
	const renameModalTrap = createFocusTrap(document.getElementById('rename-modal'));
	const moveModalTrap = createFocusTrap(document.getElementById('move-modal'));

	function openRenameDialog() {
		document.getElementById('rename-modal').classList.remove('hidden');
		renameModalTrap.activate();
		document.getElementById('rename-input').focus();
		document.getElementById('rename-input').select();
	}

	function closeRenameDialog() {
		renameModalTrap.deactivate();
		document.getElementById('rename-modal').classList.add('hidden');
	}

	function openMoveDialog() {
		document.getElementById('move-modal').classList.remove('hidden');
		moveModalTrap.activate();
	}

	function closeMoveDialog() {
		moveModalTrap.deactivate();
		document.getElementById('move-modal').classList.add('hidden');
	}

	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			closeRenameDialog();
			closeMoveDialog();
		}
	});
</script>
{{end}}
