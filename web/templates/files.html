{{define "content"}}
<!-- Create Folder Modal -->
<div id="create-folder-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeCreateFolderModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Create New Folder</h3>
				<button onclick="closeCreateFolderModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form method="POST" action="/folders/create">
				<input type="hidden" name="current_folder" value="{{.CurrentFolder}}">
				<input type="text" name="folder_name" id="folder-name-input" placeholder="Folder name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm mb-4 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeCreateFolderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Create Folder</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Rename Modal -->
<div id="rename-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeRenameModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 id="rename-modal-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100">Rename</h3>
				<button onclick="closeRenameModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form id="rename-form" method="POST" action="">
				<input type="hidden" name="current_folder" value="{{.CurrentFolder}}">
				<input type="hidden" name="old_name" id="rename-old-name" value="">
				<input type="text" name="new_name" id="rename-new-name" placeholder="New name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm mb-4 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeRenameModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Rename</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Move File Modal -->
<div id="move-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeMoveModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Move File</h3>
				<button onclick="closeMoveModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<p id="move-filename" class="text-sm text-gray-600 dark:text-gray-400 mb-4 truncate"></p>
			<form id="move-form" method="POST" action="">
				<div class="mb-4">
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select destination folder:</label>
					<select name="destination_folder" id="move-destination" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
						<option value="/">/ (Root)</option>
					</select>
				</div>
				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeMoveModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Move</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Move Folder Modal -->
<div id="move-folder-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeMoveFolderModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Move Folder</h3>
				<button onclick="closeMoveFolderModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<p id="move-folder-name" class="text-sm text-gray-600 dark:text-gray-400 mb-4 truncate"></p>
			<form id="move-folder-form" method="POST" action="/folders/move">
				<input type="hidden" name="current_folder" value="{{.CurrentFolder}}">
				<input type="hidden" name="folder_name" id="move-folder-name-input" value="">
				<div class="mb-4">
					<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select destination folder:</label>
					<select name="destination_folder" id="move-folder-destination" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
						<option value="/">/ (Root)</option>
					</select>
				</div>
				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeMoveFolderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Move</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Drag and Drop Overlay -->
<div id="drag-overlay" class="hidden fixed inset-0 bg-gray-900/95 dark:bg-black/95 border-2 border-dashed border-gray-400 dark:border-gray-600 z-[9999] items-center justify-center">
	<div class="text-center">
		<div class="mb-4 flex justify-center">
			<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white" aria-hidden="true">
				<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
				<polyline points="14 2 14 8 20 8"></polyline>
				<line x1="12" y1="18" x2="12" y2="12"></line>
				<line x1="9" y1="15" x2="15" y2="15"></line>
			</svg>
		</div>
		<h2 class="text-2xl font-bold mb-2 text-white">Drop a file here to upload</h2>
		<p class="text-gray-300">The file will be uploaded to the current folder</p>
	</div>
</div>

<div class="min-h-[calc(100vh-80px)] bg-white dark:bg-gray-800">
	<!-- Main Content -->
	<main class="p-8 max-lg:p-4">
		<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
			<h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Your Files</h1>
			
			<!-- Storage Usage -->
			<div class="relative rounded-full bg-gray-200 dark:bg-gray-700 px-4 py-2 overflow-hidden" title="Storage quota shown may be approximate. Server performs authoritative validation on uploads.">
				<div class="absolute inset-0 bg-blue-400/30 dark:bg-blue-500/30 rounded-full transition-all duration-300" style="width: {{storagePercentage .User.StorageUsed .User.StorageQuota}}%;"></div>
				<div class="relative flex items-center gap-2 text-sm font-medium text-gray-900 dark:text-gray-100 whitespace-nowrap">
					<span>Storage:</span>
					<span>{{formatBytes .User.StorageUsed}} / {{formatBytes .User.StorageQuota}}</span>
					<span class="text-gray-500 dark:text-gray-400 text-xs">~</span>
				</div>
			</div>
		</div>

		{{template "flash_messages" .}}

		<!-- Breadcrumb Navigation and Actions -->
		<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
			<div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
				{{if ne .CurrentFolder "/"}}
				<a href="/files{{if eq .ParentFolder "/"}}{{else}}?folder={{.ParentFolder}}{{end}}" class="flex items-center justify-center w-7 h-7 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-600 dark:text-gray-400" title="Go to parent folder">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<polyline points="15 18 9 12 15 6"></polyline>
					</svg>
				</a>
				{{end}}
				<div>
					{{range $index, $crumb := .Breadcrumbs}}
						{{if $index}} / {{end}}
						{{if eq $crumb.Path $.CurrentFolder}}
							<strong class="text-gray-900 dark:text-gray-100">{{$crumb.Name}}</strong>
						{{else}}
							<a href="/files?folder={{$crumb.Path}}" class="text-gray-900 dark:text-gray-100 hover:underline">{{$crumb.Name}}</a>
						{{end}}
					{{end}}
				</div>
			</div>

			<div class="flex gap-2">
				<button id="upload-button" onclick="document.getElementById('file-input').click()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300 text-sm font-medium" title="Upload File">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
						<polyline points="14 2 14 8 20 8"></polyline>
						<line x1="12" y1="18" x2="12" y2="12"></line>
						<line x1="9" y1="15" x2="15" y2="15"></line>
					</svg>
					Upload File
				</button>
				<button onclick="openCreateFolderModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300 text-sm font-medium" title="Create New Folder">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
						<line x1="12" y1="11" x2="12" y2="17"></line>
						<line x1="9" y1="14" x2="15" y2="14"></line>
					</svg>
					New Folder
				</button>
			</div>
		</div>

		<!-- Hidden upload form -->
		<form method="POST" action="/upload" enctype="multipart/form-data" id="upload-form" class="hidden">
			<input type="hidden" name="folder" value="{{.CurrentFolder}}">
			<input type="file" name="file" id="file-input">
		</form>

		<!-- Upload Progress (hidden by default, shows below action bar) -->
		<div id="upload-progress-container" class="hidden mb-4">
			<div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
				<div class="flex justify-between items-center mb-2 text-sm">
					<span id="upload-filename" class="text-gray-900 dark:text-gray-100 truncate">Uploading...</span>
					<span id="upload-percentage" class="text-gray-600 dark:text-gray-400 ml-2">0%</span>
				</div>
				<div class="h-2 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden mb-2">
					<div id="upload-progress-fill" class="h-full bg-gradient-to-r from-blue-500 to-blue-400 transition-all duration-300 rounded-full" style="width: 0%"></div>
				</div>
				<div class="flex justify-between items-center text-xs text-gray-600 dark:text-gray-400 mb-2">
					<span id="upload-speed">Speed: calculating...</span>
					<span id="upload-eta">Time remaining: calculating...</span>
				</div>
				<div class="flex gap-2 justify-end">
					<button id="pause-upload-btn" class="hidden px-3 py-1 text-xs font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded transition-colors">
						Pause
					</button>
					<button id="resume-upload-btn" class="hidden px-3 py-1 text-xs font-medium text-gray-700 dark:text-gray-300 bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors">
						Resume
					</button>
					<button id="cancel-upload-btn" class="hidden px-3 py-1 text-xs font-medium text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 rounded transition-colors">
						Cancel
					</button>
				</div>
			</div>
		</div>

		{{if or .Files .Folders}}
		{{if .Folders}}
		<!-- Folders Section -->
		<div class="mb-6">
			<h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Folders</h2>
			<div class="flex flex-wrap gap-2">
				{{range .Folders}}
				<div class="flex items-center bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg border border-gray-200 dark:border-gray-600 hover:border-gray-300 dark:hover:border-gray-500 transition-all w-full sm:w-[200px]">
						<a href="/files?folder={{if eq $.CurrentFolder "/"}}/{{.Name}}{{else}}{{$.CurrentFolder}}/{{.Name}}{{end}}" 
						   class="flex items-center gap-2 px-3 py-2 flex-1 min-w-0 cursor-pointer"
						   title="{{.Name}}">
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 dark:text-yellow-400 flex-shrink-0" aria-hidden="true">
								<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
							</svg>
							<span class="text-gray-900 dark:text-gray-100 font-medium truncate">{{.Name}}</span>
						</a>
						<!-- Folder menu button -->
						<div class="relative flex-shrink-0">
							<button type="button" 
							        onclick="toggleItemMenu(event, 'folder-menu-{{.ID}}')"
							        class="p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-r-lg transition-colors"
							        aria-label="Folder options">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-600 dark:text-gray-300">
									<circle cx="12" cy="5" r="2"></circle>
									<circle cx="12" cy="12" r="2"></circle>
									<circle cx="12" cy="19" r="2"></circle>
								</svg>
							</button>
							<!-- Folder dropdown menu -->
							<div id="folder-menu-{{.ID}}" class="hidden absolute right-0 top-full mt-1 w-36 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-50 py-1">
							<button type="button" data-item-type="folder" data-item-name="{{.Name}}" data-item-id="" onclick="openRenameModal(this.dataset.itemType, this.dataset.itemName, this.dataset.itemId)" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
								<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
									<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
									<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
								</svg>
								Rename
							</button>
							<button type="button" data-item-name="{{.Name}}" onclick="openMoveFolderModal(this.dataset.itemName)" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
								<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
									<path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
								</svg>
								Move
							</button>
							<div class="my-1 border-t border-gray-200 dark:border-gray-600"></div>
							<form method="POST" action="/folders/delete/{{.Name}}" onsubmit="return confirm('Are you sure you want to delete this folder and all its contents?');">
								<input type="hidden" name="current_folder" value="{{$.CurrentFolder}}">
								<button type="submit" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
									<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
										<polyline points="3 6 5 6 21 6"></polyline>
										<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
									</svg>
									Delete
								</button>
							</form>
							</div>
						</div>
					</div>
					{{end}}
				</div>
			</div>
			{{end}}

			{{if .Files}}
			<!-- Files Section -->
			<div>
				<h2 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Files</h2>
				<div class="overflow-x-auto">
					<table class="w-full border-collapse">
						<thead>
							<tr class="bg-gray-50 dark:bg-gray-700">
								<th class="text-left p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Name</th>
								<th class="text-left p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600 max-sm:hidden">Size</th>
								<th class="text-left p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600 max-md:hidden">Uploaded</th>
								<th class="text-right p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600 w-16"></th>
							</tr>
						</thead>
						<tbody id="files-table-body">
						{{range .Files}}
						<tr data-file-id="{{.ID}}" data-upload-status="{{.UploadStatus}}" class="file-row hover:bg-gray-50 dark:hover:bg-gray-700/50 {{if eq .UploadStatus "completed"}}cursor-pointer{{end}} {{if ne .UploadStatus "completed"}}bg-yellow-50 dark:bg-yellow-900/10{{end}}" {{if eq .UploadStatus "completed"}}onclick="navigateToFile(event, {{.ID}})"{{end}}>
							<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 max-w-0">
								<div class="flex items-center gap-2 min-w-0">
									<span class="status-indicator">
									{{if eq .UploadStatus "pending"}}
									<svg class="animate-spin flex-shrink-0" width="16" height="16" style="min-width: 16px; max-width: 16px; min-height: 16px; max-height: 16px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
										<circle class="opacity-25" cx="12" cy="12" r="10" stroke="#ca8a04" stroke-width="4"></circle>
										<path class="opacity-75" fill="#ca8a04" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
									</svg>
									{{else if eq .UploadStatus "uploading"}}
									<svg class="animate-spin flex-shrink-0" width="16" height="16" style="min-width: 16px; max-width: 16px; min-height: 16px; max-height: 16px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
										<circle class="opacity-25" cx="12" cy="12" r="10" stroke="#2563eb" stroke-width="4"></circle>
										<path class="opacity-75" fill="#2563eb" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
									</svg>
									{{end}}
									</span>
									<span class="status-label">
									{{if eq .UploadStatus "pending"}}
									<span class="text-yellow-600 dark:text-yellow-400 text-xs font-medium flex-shrink-0">Preparing...</span>
									{{else if eq .UploadStatus "uploading"}}
									<span class="text-blue-600 dark:text-blue-400 text-xs font-medium flex-shrink-0">Processing...</span>
									{{end}}
									</span>
									<span class="truncate" title="{{.Filename}}">{{.Filename}}</span>
								</div>
							</td>
							<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 max-sm:hidden">{{formatBytes .FileSize}}</td>
							<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 max-md:hidden">{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
							<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-right">
								<div class="relative inline-block">
									<button type="button" 
									        onclick="toggleItemMenu(event, 'file-menu-{{.ID}}')"
									        class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors"
									        aria-label="File options">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-gray-600 dark:text-gray-300">
											<circle cx="12" cy="5" r="2"></circle>
											<circle cx="12" cy="12" r="2"></circle>
											<circle cx="12" cy="19" r="2"></circle>
										</svg>
									</button>
									<!-- File dropdown menu -->
									<div id="file-menu-{{.ID}}" class="hidden absolute right-0 top-full mt-1 w-36 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-50 py-1">
										{{if eq .UploadStatus "completed"}}
										<a href="/files/{{.ID}}" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
											<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
												<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
												<circle cx="12" cy="12" r="3"></circle>
											</svg>
											View
										</a>
										<a href="/download/{{.ID}}" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
											<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
												<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
												<polyline points="7 10 12 15 17 10"></polyline>
												<line x1="12" y1="15" x2="12" y2="3"></line>
											</svg>
											Download
										</a>
										<button type="button" data-item-type="file" data-item-name="{{.Filename}}" data-item-id="{{.ID}}" onclick="openRenameModal(this.dataset.itemType, this.dataset.itemName, this.dataset.itemId)" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
											<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
												<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
												<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
											</svg>
											Rename
										</button>
										<button type="button" data-item-name="{{.Filename}}" data-item-id="{{.ID}}" onclick="openMoveModal(this.dataset.itemName, this.dataset.itemId)" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
											<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
												<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
												<polyline points="12 11 12 17"></polyline>
												<polyline points="9 14 12 11 15 14"></polyline>
											</svg>
											Move
										</button>
										{{else}}
										<span class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-400 dark:text-gray-500 cursor-not-allowed">
											<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
												<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
												<polyline points="7 10 12 15 17 10"></polyline>
												<line x1="12" y1="15" x2="12" y2="3"></line>
											</svg>
											Download
										</span>
										{{end}}
										<div class="my-1 border-t border-gray-200 dark:border-gray-600"></div>
										<form method="POST" action="/delete/{{.ID}}" onsubmit="return confirm('Are you sure you want to delete this file?');">
											<button type="submit" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
												<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
													<polyline points="3 6 5 6 21 6"></polyline>
													<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
												</svg>
												Delete
											</button>
										</form>
									</div>
								</div>
							</td>
						</tr>
						{{end}}
					</tbody>
				</table>
				</div>

				<!-- Pagination -->
				{{if gt .TotalPages 1}}
				<div class="flex justify-between items-center mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
					{{if gt .Page 1}}
						<a href="/files?folder={{.CurrentFolder}}&page={{.Page | add -1}}" class="bg-gray-900 dark:bg-gray-600 text-white px-4 py-2 rounded border border-gray-700 dark:border-gray-500 hover:bg-gray-700 dark:hover:bg-gray-500">← Previous</a>
					{{else}}
						<span class="px-4 py-2 rounded border border-gray-300 dark:border-gray-600 opacity-40 cursor-not-allowed text-gray-500 dark:text-gray-400">← Previous</span>
					{{end}}

					<span class="text-gray-600 dark:text-gray-400 font-medium">Page {{.Page}} of {{.TotalPages}}</span>

					{{if lt .Page .TotalPages}}
						<a href="/files?folder={{.CurrentFolder}}&page={{.Page | add 1}}" class="bg-gray-900 dark:bg-gray-600 text-white px-4 py-2 rounded border border-gray-700 dark:border-gray-500 hover:bg-gray-700 dark:hover:bg-gray-500">Next →</a>
					{{else}}
						<span class="px-4 py-2 rounded border border-gray-300 dark:border-gray-600 opacity-40 cursor-not-allowed text-gray-500 dark:text-gray-400">Next →</span>
					{{end}}
				</div>
				{{end}}
			</div>
			{{end}}
		{{else}}
			<p class="text-gray-600 dark:text-gray-400">No files in this folder yet.</p>
		{{end}}
	</main>
</div>

<!-- Chunked Upload Script -->
<script src="/static/js/chunked-upload.js"></script>

<script>
	// Focus trap utility for modal accessibility
	function createFocusTrap(modal) {
		const focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
		let firstFocusable = null;
		let lastFocusable = null;

		function updateFocusableElements() {
			const focusableElements = modal.querySelectorAll(focusableSelectors);
			const visible = Array.from(focusableElements).filter(el => {
				return el.offsetParent !== null && !el.disabled;
			});
			firstFocusable = visible[0];
			lastFocusable = visible[visible.length - 1];
		}

		function handleKeydown(e) {
			if (e.key !== 'Tab') return;

			updateFocusableElements();
			if (!firstFocusable || !lastFocusable) return;

			if (e.shiftKey) {
				if (document.activeElement === firstFocusable) {
					e.preventDefault();
					lastFocusable.focus();
				}
			} else {
				if (document.activeElement === lastFocusable) {
					e.preventDefault();
					firstFocusable.focus();
				}
			}
		}

		return {
			activate: function() {
				updateFocusableElements();
				modal.addEventListener('keydown', handleKeydown);
			},
			deactivate: function() {
				modal.removeEventListener('keydown', handleKeydown);
			}
		};
	}

	// SSE connection for real-time status updates
	let eventSource = null;
	let sseReconnectTimeout = null;

	// Track active upload state for unload warning
	let isUploading = false;

	// Initialize SSE connection for file status updates
	function initSSE() {
		// Check if there are any files that need status updates
		const pendingFiles = document.querySelectorAll('[data-upload-status="pending"], [data-upload-status="uploading"]');
		if (pendingFiles.length === 0 && !isUploading) {
			return; // No need to connect if no pending files
		}

		if (eventSource) {
			return; // Already connected
		}

		eventSource = new EventSource('/api/files/status', { withCredentials: true });

		eventSource.addEventListener('connected', function(e) {
			// Clear any reconnect timeout
			if (sseReconnectTimeout) {
				clearTimeout(sseReconnectTimeout);
				sseReconnectTimeout = null;
			}
		});

		eventSource.addEventListener('status', function(e) {
			const data = JSON.parse(e.data);
			updateFileStatus(data);
		});

		eventSource.addEventListener('error', function(e) {
			eventSource.close();
			eventSource = null;
			// Reconnect after 3 seconds
			sseReconnectTimeout = setTimeout(initSSE, 3000);
		});
	}

	// Update file row based on status event
	function updateFileStatus(data) {
		const row = document.querySelector(`tr[data-file-id="${data.id}"]`);
		
		// Handle failed uploads - show toast and auto-dismiss
		if (data.upload_status === 'failed') {
			showErrorToast(`Upload failed: ${data.filename}`, data.error_message || 'Check server logs for details.');
			// Auto-dismiss the failed upload to clean up
			dismissFailedUpload(data.id, true); // silent dismiss
			if (row) {
				row.remove();
			}
			checkSSENeeded();
			return;
		}

		if (!row) {
			// File not on current page, might need to reload for completed files
			if (data.upload_status === 'completed') {
				// Only reload if not currently uploading to avoid disruption
				if (!isUploading) {
					window.location.reload();
				}
			}
			return;
		}

		const currentStatus = row.dataset.uploadStatus;
		if (currentStatus === data.upload_status) {
			return; // No change
		}

		// Update the row's data attribute
		row.dataset.uploadStatus = data.upload_status;

		// Update row styling
		row.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/10');
		if (data.upload_status === 'pending' || data.upload_status === 'uploading') {
			row.classList.add('bg-yellow-50', 'dark:bg-yellow-900/10');
		}

		// Update status indicator
		const statusIndicator = row.querySelector('.status-indicator');
		const statusLabel = row.querySelector('.status-label');

		if (data.upload_status === 'completed') {
			statusIndicator.innerHTML = '';
			statusLabel.innerHTML = '';
			// Update the menu to show download link
			updateMenuForCompleted(row, data.id);
		} else if (data.upload_status === 'uploading') {
			statusIndicator.innerHTML = `
				<svg class="animate-spin flex-shrink-0" width="16" height="16" style="min-width: 16px; max-width: 16px; min-height: 16px; max-height: 16px;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
					<circle class="opacity-25" cx="12" cy="12" r="10" stroke="#2563eb" stroke-width="4"></circle>
					<path class="opacity-75" fill="#2563eb" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
				</svg>
			`;
			statusLabel.innerHTML = '<span class="text-blue-600 dark:text-blue-400 text-xs font-medium flex-shrink-0">Processing...</span>';
		}

		// Close SSE if no more pending files
		checkSSENeeded();
	}

	// Show error toast notification
	function showErrorToast(title, message) {
		// Create toast container if it doesn't exist
		let toastContainer = document.getElementById('toast-container');
		if (!toastContainer) {
			toastContainer = document.createElement('div');
			toastContainer.id = 'toast-container';
			// Use inline styles to ensure positioning works regardless of Tailwind
			// pointer-events: auto ensures the container captures mouse events
			toastContainer.style.cssText = 'position: fixed; top: 1rem; right: 1rem; z-index: 99999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: auto;';
			document.body.appendChild(toastContainer);
		}

		// Create toast element
		const toast = document.createElement('div');
		// pointer-events: auto ensures the toast captures mouse events
		toast.style.cssText = 'background-color: #dc2626; color: white; padding: 0.75rem 1rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-width: 24rem; display: flex; align-items: flex-start; gap: 0.75rem; position: relative; z-index: 99999; pointer-events: auto;';
		
		// Build toast content
		const icon = document.createElement('div');
		icon.style.cssText = 'flex-shrink: 0; margin-top: 0.125rem; pointer-events: auto;';
		icon.innerHTML = `<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<circle cx="12" cy="12" r="10"></circle>
			<line x1="15" y1="9" x2="9" y2="15"></line>
			<line x1="9" y1="9" x2="15" y2="15"></line>
		</svg>`;
		
		const content = document.createElement('div');
		content.style.cssText = 'flex: 1; min-width: 0; pointer-events: auto;';
		
		const titleEl = document.createElement('div');
		titleEl.style.cssText = 'font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
		titleEl.textContent = title;
		
		const messageEl = document.createElement('div');
		messageEl.style.cssText = 'font-size: 0.875rem; color: #fecaca; margin-top: 0.125rem;';
		messageEl.textContent = message;
		
		content.appendChild(titleEl);
		content.appendChild(messageEl);
		
		const closeBtn = document.createElement('button');
		closeBtn.type = 'button';
		closeBtn.style.cssText = 'flex-shrink: 0; color: #fecaca; background: none; border: none; cursor: pointer; padding: 0.25rem; display: flex; align-items: center; justify-content: center; pointer-events: auto;';
		closeBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="pointer-events: none;">
			<line x1="18" y1="6" x2="6" y2="18"></line>
			<line x1="6" y1="6" x2="18" y2="18"></line>
		</svg>`;
		closeBtn.addEventListener('click', function(e) {
			e.preventDefault();
			e.stopPropagation();
			toast.remove();
		});
		
		toast.appendChild(icon);
		toast.appendChild(content);
		toast.appendChild(closeBtn);

		toastContainer.appendChild(toast);

		// Auto-remove after 8 seconds
		setTimeout(() => {
			toast.style.opacity = '0';
			toast.style.transform = 'translateX(100%)';
			toast.style.transition = 'opacity 0.3s, transform 0.3s';
			setTimeout(() => toast.remove(), 300);
		}, 8000);
	}

	function updateMenuForCompleted(row, fileId) {
		const menu = document.getElementById(`file-menu-${fileId}`);
		if (!menu) return;

		// Get the filename from the row
		const filenameElement = row.querySelector('td:first-child span.truncate');
		const filename = filenameElement ? filenameElement.textContent : 'file';

		// Find the first child that's not the delete form and replace it with full menu
		const downloadPlaceholder = menu.querySelector('span, a');
		if (downloadPlaceholder) {
			// Create a container for the menu items
			const menuItems = document.createElement('div');
			menuItems.innerHTML = `
				<a href="/download/${fileId}" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
						<polyline points="7 10 12 15 17 10"></polyline>
						<line x1="12" y1="15" x2="12" y2="3"></line>
					</svg>
					Download
				</a>
				<button type="button" data-item-type="file" data-item-name="${escapeHtml(filename)}" data-item-id="${fileId}" onclick="openRenameModal(this.dataset.itemType, this.dataset.itemName, this.dataset.itemId)" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
						<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
					</svg>
					Rename
				</button>
				<button type="button" data-item-name="${escapeHtml(filename)}" data-item-id="${fileId}" onclick="openMoveModal(this.dataset.itemName, this.dataset.itemId)" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
						<polyline points="12 11 12 17"></polyline>
						<polyline points="9 14 12 11 15 14"></polyline>
					</svg>
					Move
				</button>
			`;
			
			// Replace the placeholder with all new menu items
			while (menuItems.firstChild) {
				downloadPlaceholder.parentNode.insertBefore(menuItems.firstChild, downloadPlaceholder);
			}
			downloadPlaceholder.remove();
		}
	}

	function escapeHtml(text) {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	}

	function checkSSENeeded() {
		const pendingFiles = document.querySelectorAll('[data-upload-status="pending"], [data-upload-status="uploading"]');
		if (pendingFiles.length === 0 && !isUploading && eventSource) {
			eventSource.close();
			eventSource = null;
		}
	}

	// Dismiss a failed upload
	// If silent is true, don't show error alerts (used for auto-dismiss after toast)
	function dismissFailedUpload(fileId, silent) {
		fetch(`/files/${fileId}/dismiss`, {
			method: 'POST',
			headers: {
				'X-CSRF-Token': document.getElementById('csrf-token').value
			}
		})
		.then(response => {
			if (response.ok) {
				// Remove the row from the table
				const row = document.querySelector(`tr[data-file-id="${fileId}"]`);
				if (row) {
					row.remove();
				}
				// Close any open menu
				if (currentOpenMenu) {
					currentOpenMenu.classList.add('hidden');
					currentOpenMenu = null;
				}
			} else if (!silent) {
				alert('Failed to dismiss upload. Please try again.');
			}
		})
		.catch(err => {
			console.error('Error dismissing upload:', err);
			if (!silent) {
				alert('Failed to dismiss upload. Please try again.');
			}
		});
	}

	// Handle page unload: warn about active uploads and clean up SSE connection
	window.addEventListener('beforeunload', function(e) {
		// Clean up SSE connection
		if (eventSource) {
			eventSource.close();
		}

		// Warn user if they try to leave during an active upload
		if (isUploading) {
			e.preventDefault();
			// Modern browsers ignore custom messages, but we need to return something
			e.returnValue = 'You have an upload in progress. Are you sure you want to leave?';
			return e.returnValue;
		}
	});

	// Create focus traps for modals
	const createFolderModalTrap = createFocusTrap(document.getElementById('create-folder-modal'));
	const renameModalTrap = createFocusTrap(document.getElementById('rename-modal'));
	const moveModalTrap = createFocusTrap(document.getElementById('move-modal'));
	const moveFolderModalTrap = createFocusTrap(document.getElementById('move-folder-modal'));

	// Create folder modal functions
	function openCreateFolderModal() {
		document.getElementById('create-folder-modal').classList.remove('hidden');
		createFolderModalTrap.activate();
		document.getElementById('folder-name-input').focus();
	}
	
	function closeCreateFolderModal() {
		createFolderModalTrap.deactivate();
		document.getElementById('create-folder-modal').classList.add('hidden');
		document.getElementById('folder-name-input').value = '';
	}

	// Rename modal functions
	function openRenameModal(type, currentName, fileId) {
		// Close any open menu first
		if (currentOpenMenu) {
			currentOpenMenu.classList.add('hidden');
			currentOpenMenu.style.position = '';
			currentOpenMenu.style.top = '';
			currentOpenMenu.style.left = '';
			currentOpenMenu.style.right = '';
			currentOpenMenu = null;
		}

		const modal = document.getElementById('rename-modal');
		const form = document.getElementById('rename-form');
		const title = document.getElementById('rename-modal-title');
		const newNameInput = document.getElementById('rename-new-name');
		const oldNameInput = document.getElementById('rename-old-name');

		if (type === 'file') {
			title.textContent = 'Rename File';
			form.action = '/rename/' + fileId;
			oldNameInput.value = ''; // Not used for files
		} else {
			title.textContent = 'Rename Folder';
			form.action = '/folders/rename';
			oldNameInput.value = currentName;
		}

		newNameInput.value = currentName;
		modal.classList.remove('hidden');
		renameModalTrap.activate();
		
		// Select the filename without extension for files, or full name for folders
		newNameInput.focus();
		if (type === 'file') {
			const lastDot = currentName.lastIndexOf('.');
			if (lastDot > 0) {
				newNameInput.setSelectionRange(0, lastDot);
			} else {
				newNameInput.select();
			}
		} else {
			newNameInput.select();
		}
	}

	function closeRenameModal() {
		renameModalTrap.deactivate();
		document.getElementById('rename-modal').classList.add('hidden');
		document.getElementById('rename-new-name').value = '';
		document.getElementById('rename-old-name').value = '';
	}

	// Move modal functions
	function openMoveModal(filename, fileId) {
		// Close any open menu first
		if (currentOpenMenu) {
			currentOpenMenu.classList.add('hidden');
			currentOpenMenu.style.position = '';
			currentOpenMenu.style.top = '';
			currentOpenMenu.style.left = '';
			currentOpenMenu.style.right = '';
			currentOpenMenu = null;
		}

		const modal = document.getElementById('move-modal');
		const form = document.getElementById('move-form');
		const filenameEl = document.getElementById('move-filename');
		const destinationSelect = document.getElementById('move-destination');

		form.action = '/move/' + fileId;
		filenameEl.textContent = 'Moving: ' + filename;

		// Populate folder list
		populateFolderList(destinationSelect);

		modal.classList.remove('hidden');
		moveModalTrap.activate();
		destinationSelect.focus();
	}

	function closeMoveModal() {
		moveModalTrap.deactivate();
		document.getElementById('move-modal').classList.add('hidden');
	}

	// Move folder modal functions
	function openMoveFolderModal(folderName) {
		// Close any open menu first
		if (currentOpenMenu) {
			currentOpenMenu.classList.add('hidden');
			currentOpenMenu.style.position = '';
			currentOpenMenu.style.top = '';
			currentOpenMenu.style.left = '';
			currentOpenMenu.style.right = '';
			currentOpenMenu = null;
		}

		const modal = document.getElementById('move-folder-modal');
		const folderNameEl = document.getElementById('move-folder-name');
		const folderNameInput = document.getElementById('move-folder-name-input');
		const destinationSelect = document.getElementById('move-folder-destination');

		folderNameEl.textContent = 'Moving: ' + folderName;
		folderNameInput.value = folderName;

		// Populate folder list, excluding the folder being moved and its subfolders
		populateFolderListForMove(destinationSelect, folderName);

		modal.classList.remove('hidden');
		moveFolderModalTrap.activate();
		destinationSelect.focus();
	}

	function closeMoveFolderModal() {
		moveFolderModalTrap.deactivate();
		document.getElementById('move-folder-modal').classList.add('hidden');
	}

	function populateFolderListForMove(selectElement, folderBeingMoved) {
		// Get current folder and build the path of the folder being moved
		const currentFolder = {{jsStr .CurrentFolder}};
		let sourcePath;
		if (currentFolder === '/') {
			sourcePath = '/' + folderBeingMoved;
		} else {
			sourcePath = currentFolder + '/' + folderBeingMoved;
		}

		const allFolders = [];
		
		// Always include root (unless moving a top-level folder to root, which would be same location)
		allFolders.push('/');
		
		// Add folders from the current view
		{{range .Folders}}
		{{if eq $.CurrentFolder "/"}}
		const folderPath{{.ID}} = {{printf "/%s" .Name | jsStr}};
		{{else}}
		const folderPath{{.ID}} = {{printf "%s/%s" $.CurrentFolder .Name | jsStr}};
		{{end}}
		// Exclude the folder being moved and its subfolders
		if (folderPath{{.ID}} !== sourcePath && !folderPath{{.ID}}.startsWith(sourcePath + '/')) {
			allFolders.push(folderPath{{.ID}});
		}
		{{end}}
		
		// Add parent folders from breadcrumbs
		{{range .Breadcrumbs}}
		{{if ne .Path "/"}}
		{
			const breadcrumbPath = {{jsStr .Path}};
			// Exclude the folder being moved and its subfolders
			if (breadcrumbPath !== sourcePath && !breadcrumbPath.startsWith(sourcePath + '/') && !allFolders.includes(breadcrumbPath)) {
				allFolders.push(breadcrumbPath);
			}
		}
		{{end}}
		{{end}}
		
		// Sort folders
		allFolders.sort();
		
		// Clear existing options
		selectElement.innerHTML = '';
		
		// Add options
		allFolders.forEach(function(folder) {
			const option = document.createElement('option');
			option.value = folder;
			if (folder === '/') {
				option.textContent = '/ (Root)';
			} else {
				option.textContent = folder;
			}
			// Pre-select current folder
			if (folder === currentFolder) {
				option.selected = true;
			}
			selectElement.appendChild(option);
		});
	}

	function populateFolderList(selectElement) {
		// Get all available folders from the page data
		// Using jsStr template function to prevent XSS from special characters in folder names
		const currentFolder = {{jsStr .CurrentFolder}};
		const allFolders = [];
		
		// Always include root
		allFolders.push('/');
		
		// Add folders from the current view
		{{range .Folders}}
		{{if eq $.CurrentFolder "/"}}
		allFolders.push({{printf "/%s" .Name | jsStr}});
		{{else}}
		allFolders.push({{printf "%s/%s" $.CurrentFolder .Name | jsStr}});
		{{end}}
		{{end}}
		
		// Add parent folders from breadcrumbs
		{{range .Breadcrumbs}}
		{{if ne .Path "/"}}
		if (!allFolders.includes({{jsStr .Path}})) {
			allFolders.push({{jsStr .Path}});
		}
		{{end}}
		{{end}}
		
		// Sort folders
		allFolders.sort();
		
		// Clear existing options
		selectElement.innerHTML = '';
		
		// Add options
		allFolders.forEach(function(folder) {
			const option = document.createElement('option');
			option.value = folder;
			if (folder === '/') {
				option.textContent = '/ (Root)';
			} else {
				option.textContent = folder;
			}
			// Pre-select current folder
			if (folder === currentFolder) {
				option.selected = true;
			}
			selectElement.appendChild(option);
		});
	}

	// Folder menu functions
	let currentOpenMenu = null;

	// Navigate to file view page
	function navigateToFile(event, fileId) {
		// Don't navigate if clicking on the menu button or within the menu
		if (event.target.closest('button') || event.target.closest('[id^="file-menu-"]')) {
			return;
		}
		window.location.href = '/files/' + fileId;
	}

	function toggleItemMenu(event, menuId) {
		event.preventDefault();
		event.stopPropagation();
		
		const menu = document.getElementById(menuId);
		const button = event.currentTarget;
		
		// Close any other open menu
		if (currentOpenMenu && currentOpenMenu !== menu) {
			currentOpenMenu.classList.add('hidden');
			currentOpenMenu.style.position = '';
			currentOpenMenu.style.top = '';
			currentOpenMenu.style.left = '';
			currentOpenMenu.style.right = '';
		}
		
		// Toggle this menu
		if (menu.classList.contains('hidden')) {
			// Position the menu using fixed positioning to escape overflow containers
			const rect = button.getBoundingClientRect();
			menu.style.position = 'fixed';
			menu.style.top = (rect.bottom + 4) + 'px';
			
			// Calculate right offset and check for overflow on small screens
			const rightOffset = window.innerWidth - rect.right;
			const menuWidth = 160; // Approximate menu width (w-40 = 10rem = 160px)
			
			// If menu would overflow left edge, switch to left alignment
			if (rect.right - menuWidth < 0) {
				menu.style.left = '4px';
				menu.style.right = 'auto';
			} else {
				menu.style.right = rightOffset + 'px';
				menu.style.left = 'auto';
			}
			
			menu.classList.remove('hidden');
			currentOpenMenu = menu;
		} else {
			menu.classList.add('hidden');
			menu.style.position = '';
			menu.style.top = '';
			menu.style.left = '';
			menu.style.right = '';
			currentOpenMenu = null;
		}
	}

	// Close menu when clicking outside
	document.addEventListener('click', function(e) {
		if (currentOpenMenu && !e.target.closest('[id^="folder-menu-"]') && !e.target.closest('[id^="file-menu-"]') && !e.target.closest('button[onclick^="toggleItemMenu"]')) {
			currentOpenMenu.classList.add('hidden');
			currentOpenMenu.style.position = '';
			currentOpenMenu.style.top = '';
			currentOpenMenu.style.left = '';
			currentOpenMenu.style.right = '';
			currentOpenMenu = null;
		}
	});
	
	// Close modal on Escape key
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			closeCreateFolderModal();
			closeRenameModal();
			closeMoveModal();
			closeMoveFolderModal();
			// Also close any open folder menu
			if (currentOpenMenu) {
				currentOpenMenu.classList.add('hidden');
				currentOpenMenu = null;
			}
		}
	});


	// Drag and drop functionality
	const dragOverlay = document.getElementById('drag-overlay');
	const uploadForm = document.getElementById('upload-form');
	const fileInput = document.getElementById('file-input');
	const uploadButton = document.getElementById('upload-button');
	const progressContainer = document.getElementById('upload-progress-container');
	const progressFill = document.getElementById('upload-progress-fill');
	const uploadPercentage = document.getElementById('upload-percentage');
	const uploadFilename = document.getElementById('upload-filename');

	// File size limits from server config
	const maxUploadSize = {{.MaxUploadSize}};
	const userStorageUsed = {{.User.StorageUsed}};
	const userStorageQuota = {{.User.StorageQuota}};
	const remainingQuota = userStorageQuota - userStorageUsed;

	// Helper to format bytes for display
	function formatBytes(bytes) {
		if (bytes === 0) return '0 B';
		const k = 1024;
		const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
	}

	// Chunked upload manager instance
	const chunkSize = 5 * 1024 * 1024; // 5MB chunks (configurable)
	const chunkedUploadManager = new ChunkedUploadManager({ chunkSize });
	let currentUploadId = null;
	let uploadStartTime = null;
	let uploadBytesStart = 0;

	// Function to upload file with progress tracking
	function uploadFile(file) {
		// Start SSE connection for status updates
		initSSE();

		// Best-effort client-side validation based on page load data.
		// Note: Quota may be stale if uploads occur in other tabs/windows.
		// Server-side validation is authoritative; page reloads after successful uploads.
		if (file.size > maxUploadSize) {
			alert('File too large. Maximum size is ' + formatBytes(maxUploadSize) + '.\nYour file: ' + formatBytes(file.size));
			return;
		}

		if (file.size > remainingQuota) {
			alert('Insufficient storage quota.\nFile size: ' + formatBytes(file.size) + '\nRemaining quota: ' + formatBytes(remainingQuota));
			return;
		}

		const folder = uploadForm.querySelector('input[name="folder"]').value;

		// Determine if we should use chunked upload (for files > 10MB)
		const useChunkedUpload = file.size > 10 * 1024 * 1024;

		if (useChunkedUpload) {
			uploadFileChunked(file, folder);
		} else {
			uploadFileTraditional(file, folder);
		}
	}

	// Chunked upload for large files (resumable)
	function uploadFileChunked(file, folder) {
		isUploading = true;
		uploadStartTime = Date.now();
		uploadBytesStart = 0;

		// Show progress UI
		uploadButton.classList.add('hidden');
		progressContainer.classList.remove('hidden');
		uploadFilename.textContent = file.name;
		uploadPercentage.textContent = '0%';
		progressFill.style.width = '0%';
		document.getElementById('upload-speed').textContent = 'Speed: calculating...';
		document.getElementById('upload-eta').textContent = 'Time remaining: calculating...';
		document.getElementById('pause-upload-btn').classList.remove('hidden');
		document.getElementById('cancel-upload-btn').classList.remove('hidden');
		document.getElementById('resume-upload-btn').classList.add('hidden');

		chunkedUploadManager.startUpload(file, {
			folder,
			onProgress: (progress) => {
				currentUploadId = progress.uploadId;
				const percentage = progress.percentage;
				progressFill.style.width = percentage + '%';
				uploadPercentage.textContent = percentage + '%';

				// Calculate speed and ETA
				const currentTime = Date.now();
				const elapsedSeconds = (currentTime - uploadStartTime) / 1000;
				const uploadedBytes = progress.uploadedBytes;
				
				if (elapsedSeconds > 0.5) {
					const speed = uploadedBytes / elapsedSeconds;
					const remainingBytes = file.size - uploadedBytes;
					const eta = speed > 0 ? remainingBytes / speed : 0;

					document.getElementById('upload-speed').textContent = 'Speed: ' + formatBytes(speed) + '/s';
					
					if (eta > 0) {
						const etaFormatted = eta < 60 
							? Math.round(eta) + 's' 
							: Math.floor(eta / 60) + 'm ' + Math.round(eta % 60) + 's';
						document.getElementById('upload-eta').textContent = 'Time remaining: ' + etaFormatted;
					}
				}
			},
			onComplete: (result) => {
				isUploading = false;
				currentUploadId = null;
				// Success - reload page to show updated file list
				window.location.reload();
			},
			onError: (error) => {
				isUploading = false;
				currentUploadId = null;
				alert('Upload failed: ' + error.message);
				progressContainer.classList.add('hidden');
				uploadButton.classList.remove('hidden');
				checkSSENeeded();
			}
		});
	}

	// Traditional upload for small files
	function uploadFileTraditional(file, folder) {
		const formData = new FormData();
		formData.append('file', file);
		formData.append('folder', folder);

		// Mark upload as active for beforeunload warning
		isUploading = true;

		// Hide upload button and show progress bar
		uploadButton.classList.add('hidden');
		progressContainer.classList.remove('hidden');
		uploadFilename.textContent = file.name;
		uploadPercentage.textContent = '0%';
		progressFill.style.width = '0%';
		document.getElementById('upload-speed').textContent = 'Speed: calculating...';
		document.getElementById('upload-eta').textContent = 'Time remaining: calculating...';
		// Hide pause/resume/cancel for traditional upload
		document.getElementById('pause-upload-btn').classList.add('hidden');
		document.getElementById('resume-upload-btn').classList.add('hidden');
		document.getElementById('cancel-upload-btn').classList.add('hidden');

		// Create XHR for upload with progress tracking
		const xhr = new XMLHttpRequest();
		
		// Variables for speed calculation with moving average
		const startTime = Date.now();
		let lastTime = startTime;
		let lastLoaded = 0;
		const speedSamples = []; // Store recent speed samples for averaging
		const maxSpeedSamples = 5; // Average over last ~2.5 seconds (5 samples at 500ms)

		// Track upload progress
		xhr.upload.addEventListener('progress', function(e) {
			if (e.lengthComputable) {
				const percentage = Math.round((e.loaded / e.total) * 100);
				progressFill.style.width = percentage + '%';
				uploadPercentage.textContent = percentage + '%';

				// Calculate speed and ETA
				const currentTime = Date.now();
				const timeDiff = (currentTime - lastTime) / 1000; // seconds
				const bytesDiff = e.loaded - lastLoaded;

				// Update speed every 500ms to smooth out fluctuations
				if (timeDiff >= 0.5) {
					const instantSpeed = bytesDiff / timeDiff; // bytes per second
					
					// Add to speed samples and maintain window size
					speedSamples.push(instantSpeed);
					if (speedSamples.length > maxSpeedSamples) {
						speedSamples.shift();
					}
					
					// Calculate moving average speed
					const avgSpeed = speedSamples.reduce((a, b) => a + b, 0) / speedSamples.length;
					
					const remainingBytes = e.total - e.loaded;
					const eta = avgSpeed > 0 ? remainingBytes / avgSpeed : 0; // seconds

					// Update UI
					document.getElementById('upload-speed').textContent = 'Speed: ' + formatBytes(avgSpeed) + '/s';
					
					if (eta > 0) {
						const etaFormatted = eta < 60 
							? Math.round(eta) + 's' 
							: Math.floor(eta / 60) + 'm ' + Math.round(eta % 60) + 's';
						document.getElementById('upload-eta').textContent = 'Time remaining: ' + etaFormatted;
					} else {
						document.getElementById('upload-eta').textContent = 'Time remaining: calculating...';
					}

					lastTime = currentTime;
					lastLoaded = e.loaded;
				}
			}
		});

		// Handle completion
		xhr.addEventListener('load', function() {
			isUploading = false;
			if (xhr.status === 200 || xhr.status === 302 || xhr.status === 303) {
				// Success - reload page to show updated file list
				// SSE will handle status updates for background processing
				window.location.reload();
			} else {
				// Error - try to parse server error message
				let errorMsg = 'Upload failed. Please try again.';
				try {
					const response = JSON.parse(xhr.responseText);
					if (response.error) errorMsg = response.error;
				} catch (e) {
					// Use response text if not JSON
					if (xhr.responseText) errorMsg = xhr.responseText;
				}
				alert(errorMsg);
				progressContainer.classList.add('hidden');
				uploadButton.classList.remove('hidden');
				checkSSENeeded();
			}
		});

		// Handle errors
		xhr.addEventListener('error', function() {
			isUploading = false;
			alert('Upload failed. Please try again.');
			progressContainer.classList.add('hidden');
			uploadButton.classList.remove('hidden');
			checkSSENeeded();
		});

		// Note: /upload is exempted from CSRF middleware for streaming and is
		// protected by session authentication and SameSite cookie policy instead.
		xhr.open('POST', '/upload');
		xhr.send(formData);
	}

	// Pause/Resume/Cancel button handlers
	document.getElementById('pause-upload-btn').addEventListener('click', function() {
		if (currentUploadId) {
			chunkedUploadManager.pauseUpload(currentUploadId);
			document.getElementById('pause-upload-btn').classList.add('hidden');
			document.getElementById('resume-upload-btn').classList.remove('hidden');
		}
	});

	document.getElementById('resume-upload-btn').addEventListener('click', function() {
		if (currentUploadId) {
			chunkedUploadManager.resumeUpload(currentUploadId);
			document.getElementById('resume-upload-btn').classList.add('hidden');
			document.getElementById('pause-upload-btn').classList.remove('hidden');
		}
	});

	document.getElementById('cancel-upload-btn').addEventListener('click', function() {
		if (currentUploadId && confirm('Are you sure you want to cancel this upload?')) {
			chunkedUploadManager.cancelUpload(currentUploadId);
			currentUploadId = null;
			isUploading = false;
			progressContainer.classList.add('hidden');
			uploadButton.classList.remove('hidden');
			checkSSENeeded();
		}
	});

	// Prevent default drag behaviors on the entire page
	['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
		document.body.addEventListener(eventName, preventDefaults, false);
	});

	function preventDefaults(e) {
		e.preventDefault();
		e.stopPropagation();
	}

	// Drag overlay visibility management using timeout-based approach
	// This avoids issues with dragenter/dragleave event asymmetry on nested elements
	let dragOverlayTimeout = null;

	function showDragOverlay() {
		dragOverlay.classList.remove('hidden');
		dragOverlay.classList.add('flex');
	}

	function hideDragOverlay() {
		dragOverlay.classList.add('hidden');
		dragOverlay.classList.remove('flex');
	}

	// Show overlay on dragover (fires continuously while dragging)
	document.body.addEventListener('dragover', function(e) {
		if (e.dataTransfer.types.includes('Files')) {
			showDragOverlay();
			// Reset timeout on each dragover event
			clearTimeout(dragOverlayTimeout);
			dragOverlayTimeout = setTimeout(hideDragOverlay, 100);
		}
	});

	// Handle file drop
	document.body.addEventListener('drop', function(e) {
		clearTimeout(dragOverlayTimeout);
		hideDragOverlay();
		
		const files = e.dataTransfer.files;
		if (files.length > 0) {
			uploadFile(files[0]);
		}
	});

	// Handle file selection via button
	fileInput.addEventListener('change', function() {
		if (this.files.length > 0) {
			uploadFile(this.files[0]);
		}
	});

	// Initialize SSE if there are pending/uploading files on page load
	{{if .Files}}
	(function() {
		let hasPendingFiles = false;
		{{range .Files}}
		{{if or (eq .UploadStatus "pending") (eq .UploadStatus "uploading")}}
		hasPendingFiles = true;
		{{end}}
		{{end}}
		
		if (hasPendingFiles) {
			initSSE();
		}
	})();
	{{end}}

	// Show toast notifications for any failed uploads and auto-dismiss them
	{{if .FailedUploads}}
	(function() {
		{{range .FailedUploads}}
		showErrorToast('Upload failed: {{.OriginalFilename}}', 'Check server logs for details.');
		dismissFailedUpload({{.ID}}, true);
		{{end}}
	})();
	{{end}}

</script>

{{end}}
