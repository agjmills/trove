{{define "content"}}
<!-- Drag and Drop Overlay -->
<div id="drag-overlay" class="drag-overlay" style="display: none;">
	<div class="drag-overlay-content">
		<div class="drag-icon">ğŸ“¤</div>
		<h2>Drop files here to upload</h2>
		<p>Files will be uploaded to the current folder</p>
	</div>
</div>

<h1>Dashboard</h1>

<!-- Flash Messages -->
{{if .Flash}}
<div class="flash flash-{{.Flash.Type}}">
	{{.Flash.Content}}
</div>
{{end}}

<!-- Breadcrumb Navigation -->
<div class="breadcrumbs">
	{{range $index, $crumb := .Breadcrumbs}}
		{{if $index}} / {{end}}
		{{if eq $crumb.Path $.CurrentFolder}}
			<strong>{{$crumb.Name}}</strong>
		{{else}}
			<a href="/dashboard?folder={{$crumb.Path}}">{{$crumb.Name}}</a>
		{{end}}
	{{end}}
</div>

<div class="stats">
	<div class="stat">
		<span class="label">Storage Used</span>
		<span class="value">{{formatBytes .User.StorageUsed}} / {{formatBytes .User.StorageQuota}}</span>
	</div>
</div>

<div class="upload-section">
	<form method="POST" action="/upload" enctype="multipart/form-data" class="inline-form" id="upload-form">
		<input type="hidden" name="folder" value="{{.CurrentFolder}}">
		<input type="file" name="file" id="file-input" required style="display: none;">
		<button type="button" id="upload-button" onclick="document.getElementById('file-input').click()">ğŸ“¤ Upload File</button>
	</form>
	
	<form method="POST" action="/folders/create" class="inline-form">
		<input type="hidden" name="current_folder" value="{{.CurrentFolder}}">
		<input type="text" name="folder_name" placeholder="New folder name" required>
		<button type="submit">ğŸ“ Create Folder</button>
	</form>
</div>

<!-- Upload Progress Bar -->
<div id="upload-progress-container" class="upload-progress-container" style="display: none;">
	<div class="upload-progress-content">
		<div class="upload-progress-text">
			<span id="upload-filename">Uploading...</span>
			<span id="upload-percentage">0%</span>
		</div>
		<div class="upload-progress-bar">
			<div id="upload-progress-fill" class="upload-progress-fill"></div>
		</div>
	</div>
</div>

<div class="files-section">
	<h2>Your Files</h2>
	{{if or .Files .Folders (ne .CurrentFolder "/")}}
		<table>
			<thead>
				<tr>
					<th>Name</th>
					<th>Size</th>
					<th>Uploaded</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				{{if ne .CurrentFolder "/"}}
				<tr class="parent-directory">
					<td>
						<a href="/dashboard{{if eq .ParentFolder "/"}}{{else}}?folder={{.ParentFolder}}{{end}}">
							ğŸ“ â†©ï¸ Parent Directory
						</a>
					</td>
					<td>-</td>
					<td>-</td>
					<td></td>
				</tr>
				{{end}}
				{{range .Folders}}
				<tr>
					<td>
						<a href="/dashboard?folder={{if eq $.CurrentFolder "/"}}/{{.}}{{else}}{{$.CurrentFolder}}/{{.}}{{end}}">
							ğŸ“ {{.}}
						</a>
					</td>
					<td>-</td>
					<td>-</td>
					<td>
						<form method="POST" action="/folders/delete/{{.}}" style="display:inline">
							<input type="hidden" name="current_folder" value="{{$.CurrentFolder}}">
							<button type="submit">Delete</button>
						</form>
					</td>
				</tr>
				{{end}}
				{{range .Files}}
				<tr>
					<td>{{.OriginalFilename}}</td>
					<td>{{formatBytes .FileSize}}</td>
					<td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
					<td>
						<button class="download-btn" onclick="window.location='/download/{{.ID}}'">Download</button>
						<form method="POST" action="/delete/{{.ID}}" style="display:inline">
							<button type="submit">Delete</button>
						</form>
					</td>
				</tr>
				{{end}}
			</tbody>
		</table>
	{{else}}
		<p>No files in this folder yet.</p>
	{{end}}
</div>

<script>
	// Drag and drop functionality
	const dragOverlay = document.getElementById('drag-overlay');
	const uploadForm = document.getElementById('upload-form');
	const fileInput = document.getElementById('file-input');
	const uploadButton = document.getElementById('upload-button');
	const progressContainer = document.getElementById('upload-progress-container');
	const progressFill = document.getElementById('upload-progress-fill');
	const uploadPercentage = document.getElementById('upload-percentage');
	const uploadFilename = document.getElementById('upload-filename');
	let dragCounter = 0;

	// Function to upload file with progress tracking
	function uploadFile(file) {
		const formData = new FormData();
		formData.append('file', file);
		formData.append('folder', uploadForm.querySelector('input[name="folder"]').value);

		// Show progress bar
		progressContainer.style.display = 'block';
		uploadFilename.textContent = file.name;
		uploadPercentage.textContent = '0%';
		progressFill.style.width = '0%';
		
		// Disable upload button during upload
		uploadButton.disabled = true;

		const xhr = new XMLHttpRequest();

		// Track upload progress
		xhr.upload.addEventListener('progress', function(e) {
			if (e.lengthComputable) {
				const percentage = Math.round((e.loaded / e.total) * 100);
				progressFill.style.width = percentage + '%';
				uploadPercentage.textContent = percentage + '%';
			}
		});

		// Handle completion
		xhr.addEventListener('load', function() {
			if (xhr.status === 200 || xhr.status === 302 || xhr.status === 303) {
				// Success - reload page to show updated file list
				window.location.reload();
			} else {
				// Error
				alert('Upload failed. Please try again.');
				progressContainer.style.display = 'none';
				uploadButton.disabled = false;
			}
		});

		// Handle errors
		xhr.addEventListener('error', function() {
			alert('Upload failed. Please try again.');
			progressContainer.style.display = 'none';
			uploadButton.disabled = false;
		});

		// Send request
		xhr.open('POST', '/upload');
		xhr.send(formData);
	}

	// Prevent default drag behaviors on the entire page
	['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
		document.body.addEventListener(eventName, preventDefaults, false);
	});

	function preventDefaults(e) {
		e.preventDefault();
		e.stopPropagation();
	}

	// Show overlay when dragging files over the window
	document.body.addEventListener('dragenter', function(e) {
		if (e.dataTransfer.types.includes('Files')) {
			dragCounter++;
			dragOverlay.style.display = 'flex';
		}
	});

	document.body.addEventListener('dragleave', function(e) {
		dragCounter--;
		if (dragCounter === 0) {
			dragOverlay.style.display = 'none';
		}
	});

	// Handle file drop
	document.body.addEventListener('drop', function(e) {
		dragCounter = 0;
		dragOverlay.style.display = 'none';
		
		const files = e.dataTransfer.files;
		if (files.length > 0) {
			uploadFile(files[0]);
		}
	});

	// Also hide overlay when dragging over it
	dragOverlay.addEventListener('dragover', function(e) {
		e.preventDefault();
	});

	// Handle file selection via button
	fileInput.addEventListener('change', function() {
		if (this.files.length > 0) {
			uploadFile(this.files[0]);
		}
	});
</script>

{{end}}
