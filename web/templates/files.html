{{define "content"}}
<!-- Create Folder Modal -->
<div id="create-folder-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70" onclick="closeCreateFolderModal()"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Create New Folder</h3>
				<button onclick="closeCreateFolderModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none">&times;</button>
			</div>
			<form method="POST" action="/folders/create">
				<input type="hidden" name="current_folder" value="{{.CurrentFolder}}">
				<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
				<input type="text" name="folder_name" id="folder-name-input" placeholder="Folder name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm mb-4 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">
				<div class="flex gap-3 justify-end">
					<button type="button" onclick="closeCreateFolderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Create Folder</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Drag and Drop Overlay -->
<div id="drag-overlay" class="hidden fixed inset-0 bg-gray-900/95 dark:bg-black/95 border-2 border-dashed border-gray-400 dark:border-gray-600 z-[9999] items-center justify-center">
	<div class="text-center">
		<div class="text-6xl mb-4">ğŸ“¤</div>
		<h2 class="text-2xl font-bold mb-2 text-white">Drop files here to upload</h2>
		<p class="text-gray-300">Files will be uploaded to the current folder</p>
	</div>
</div>

<div class="flex gap-0 min-h-[calc(100vh-80px)] bg-gray-50 dark:bg-gray-900">
	<aside id="sidebar" class="w-[280px] bg-white dark:bg-gray-800 p-6 border-r border-gray-200 dark:border-gray-700 h-[calc(100vh-80px)] sticky top-0 flex-shrink-0 overflow-y-auto transition-transform duration-300 max-lg:fixed max-lg:top-0 max-lg:left-0 max-lg:w-4/5 max-lg:max-w-[320px] max-lg:h-screen max-lg:z-[999] max-lg:shadow-xl max-lg:-translate-x-full">
		<!-- Navigation links - mobile only (at top) -->
		<div class="hidden max-lg:block mb-6 pb-6 border-b border-gray-100 dark:border-gray-700">
			<div class="text-xs text-gray-600 dark:text-gray-400 mb-3">
				Signed in as <strong class="text-gray-900 dark:text-gray-100">{{.User.Username}}</strong>
			</div>
			<div class="space-y-2">
				<a href="/files" class="block px-3 py-2 rounded-lg bg-gray-900 dark:bg-gray-600 text-white transition-colors no-underline font-medium">
					ğŸ“ Files
				</a>
				<a href="/settings" class="block px-3 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors no-underline font-medium">
					âš™ï¸ Settings
				</a>
				<form action="/logout" method="POST">
					<button type="submit" class="w-full text-left px-3 py-2 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors font-medium">
						ğŸšª Logout
					</button>
				</form>
			</div>
		</div>
	</aside>

	<!-- Main Content -->
	<main class="flex-1 min-w-0 p-8 max-lg:p-4 bg-white dark:bg-gray-800">
		<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
			<h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Your Files</h1>
			
			<!-- Storage Usage -->
			<div class="flex items-center gap-4 bg-gray-50 dark:bg-gray-700 rounded-lg px-4 py-3">
				<div class="text-sm text-gray-600 dark:text-gray-400">Storage:</div>
				<div class="text-sm font-medium text-gray-900 dark:text-gray-100 whitespace-nowrap">{{formatBytes .User.StorageUsed}} / {{formatBytes .User.StorageQuota}}</div>
			</div>
		</div>

		<!-- Flash Messages -->
		{{if .Flash}}
		<div class="p-4 rounded mb-4 border-l-4 {{if eq .Flash.Type "error"}}bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 border-red-600{{else if eq .Flash.Type "success"}}bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400 border-green-600{{else}}bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 border-blue-600{{end}}">
			{{.Flash.Content}}
		</div>
		{{end}}

		<!-- Breadcrumb Navigation -->
		<div class="mb-6 py-3 text-sm text-gray-600 dark:text-gray-400">
			{{range $index, $crumb := .Breadcrumbs}}
				{{if $index}} / {{end}}
				{{if eq $crumb.Path $.CurrentFolder}}
					<strong class="text-gray-900 dark:text-gray-100">{{$crumb.Name}}</strong>
				{{else}}
					<a href="/files?folder={{$crumb.Path}}" class="text-gray-900 dark:text-gray-100 hover:underline">{{$crumb.Name}}</a>
				{{end}}
			{{end}}
		</div>

		{{if or .Files .Folders (ne .CurrentFolder "/")}}
			<!-- Hidden upload form -->
			<form method="POST" action="/upload" enctype="multipart/form-data" id="upload-form" class="hidden">
				<input type="hidden" name="folder" value="{{.CurrentFolder}}">
				<input type="hidden" name="csrf_token" value="{{.CSRFToken}}" id="csrf-token">
				<input type="file" name="file" id="file-input" required>
			</form>

			<!-- Upload Progress (hidden by default, shows below action bar) -->
			<div id="upload-progress-container" class="hidden mb-4">
				<div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
					<div class="flex justify-between items-center mb-2 text-sm">
						<span id="upload-filename" class="text-gray-900 dark:text-gray-100 truncate">Uploading...</span>
						<span id="upload-percentage" class="text-gray-600 dark:text-gray-400 ml-2">0%</span>
					</div>
					<div class="h-2 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden mb-2">
						<div id="upload-progress-fill" class="h-full bg-gradient-to-r from-blue-500 to-blue-400 transition-all duration-300 rounded-full" style="width: 0%"></div>
					</div>
					<div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
						<span id="upload-speed">Speed: calculating...</span>
						<span id="upload-eta">Time remaining: calculating...</span>
					</div>
				</div>
			</div>

			<!-- Actions bar above table -->
			<div class="flex justify-end gap-2 mb-4">
				<button id="upload-button" onclick="document.getElementById('file-input').click()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300 text-sm font-medium" title="Upload File(s)">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
						<polyline points="14 2 14 8 20 8"></polyline>
						<line x1="12" y1="18" x2="12" y2="12"></line>
						<line x1="9" y1="15" x2="15" y2="15"></line>
					</svg>
					Upload File(s)
				</button>
				<button onclick="openCreateFolderModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-300 text-sm font-medium" title="Create New Folder">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
						<line x1="12" y1="11" x2="12" y2="17"></line>
						<line x1="9" y1="14" x2="15" y2="14"></line>
					</svg>
					New Folder
				</button>
			</div>

			<div class="overflow-x-auto">
				<table class="w-full border-collapse">
					<thead>
						<tr class="bg-gray-50 dark:bg-gray-700">
							<th class="text-left p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Name</th>
							<th class="text-left p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Size</th>
							<th class="text-left p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600 max-md:hidden">Uploaded</th>
							<th class="text-left p-3 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Actions</th>
						</tr>
					</thead>
					<tbody>
					{{if ne .CurrentFolder "/"}}
					<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
						<td class="p-3 border-b border-gray-200 dark:border-gray-700">
							<a href="/files{{if eq .ParentFolder "/"}}{{else}}?folder={{.ParentFolder}}{{end}}" class="text-blue-600 dark:text-blue-400 hover:underline">
								ğŸ“ â†©ï¸ Parent Directory
							</a>
						</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">-</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 max-md:hidden">-</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700"></td>
					</tr>
					{{end}}
					{{range .Folders}}
					<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
						<td class="p-3 border-b border-gray-200 dark:border-gray-700">
							<a href="/files?folder={{if eq $.CurrentFolder "/"}}/{{.}}{{else}}{{$.CurrentFolder}}/{{.}}{{end}}" class="text-blue-600 dark:text-blue-400 hover:underline">
								ğŸ“ {{.}}
							</a>
						</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">-</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 max-md:hidden">-</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700">
							<form method="POST" action="/folders/delete/{{.}}" class="inline">
								<input type="hidden" name="current_folder" value="{{$.CurrentFolder}}">
								<input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
								<button type="submit" class="bg-gray-900 dark:bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 dark:hover:bg-gray-500">Delete</button>
							</form>
						</td>
					</tr>
					{{end}}
					{{range .Files}}
					<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
						<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 max-w-[150px] md:max-w-none truncate">{{.OriginalFilename}}</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">{{formatBytes .FileSize}}</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 max-md:hidden">{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
						<td class="p-3 border-b border-gray-200 dark:border-gray-700">
							<button class="bg-gray-900 dark:bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 dark:hover:bg-gray-500 mr-2" onclick="window.location='/download/{{.ID}}'">Download</button>
							<form method="POST" action="/delete/{{.ID}}" class="inline">
								<input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
								<button type="submit" class="bg-gray-900 dark:bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 dark:hover:bg-gray-500">Delete</button>
							</form>
						</td>
					</tr>
					{{end}}
				</tbody>
			</table>
			</div>

			<!-- Pagination -->
			{{if gt .TotalPages 1}}
			<div class="flex justify-between items-center mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600">
				{{if gt .Page 1}}
					<a href="/files?folder={{.CurrentFolder}}&page={{.Page | add -1}}" class="bg-gray-900 dark:bg-gray-600 text-white px-4 py-2 rounded border border-gray-700 dark:border-gray-500 hover:bg-gray-700 dark:hover:bg-gray-500">â† Previous</a>
				{{else}}
					<span class="px-4 py-2 rounded border border-gray-300 dark:border-gray-600 opacity-40 cursor-not-allowed text-gray-500 dark:text-gray-400">â† Previous</span>
				{{end}}

				<span class="text-gray-600 dark:text-gray-400 font-medium">Page {{.Page}} of {{.TotalPages}}</span>

				{{if lt .Page .TotalPages}}
					<a href="/files?folder={{.CurrentFolder}}&page={{.Page | add 1}}" class="bg-gray-900 dark:bg-gray-600 text-white px-4 py-2 rounded border border-gray-700 dark:border-gray-500 hover:bg-gray-700 dark:hover:bg-gray-500">Next â†’</a>
				{{else}}
					<span class="px-4 py-2 rounded border border-gray-300 dark:border-gray-600 opacity-40 cursor-not-allowed text-gray-500 dark:text-gray-400">Next â†’</span>
				{{end}}
			</div>
			{{end}}
		{{else}}
			<p class="text-gray-600 dark:text-gray-400">No files in this folder yet.</p>
		{{end}}
	</main>
</div>

<script>
	// Create folder modal functions
	function openCreateFolderModal() {
		document.getElementById('create-folder-modal').classList.remove('hidden');
		document.getElementById('folder-name-input').focus();
	}
	
	function closeCreateFolderModal() {
		document.getElementById('create-folder-modal').classList.add('hidden');
		document.getElementById('folder-name-input').value = '';
	}
	
	// Close modal on Escape key
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			closeCreateFolderModal();
		}
	});

	// Drag and drop functionality
	const dragOverlay = document.getElementById('drag-overlay');
	const uploadForm = document.getElementById('upload-form');
	const fileInput = document.getElementById('file-input');
	const uploadButton = document.getElementById('upload-button');
	const progressContainer = document.getElementById('upload-progress-container');
	const progressFill = document.getElementById('upload-progress-fill');
	const uploadPercentage = document.getElementById('upload-percentage');
	const uploadFilename = document.getElementById('upload-filename');
	let dragCounter = 0;

	// File size limits from server config
	const maxUploadSize = {{.MaxUploadSize}};
	const userStorageUsed = {{.User.StorageUsed}};
	const userStorageQuota = {{.User.StorageQuota}};
	const remainingQuota = userStorageQuota - userStorageUsed;

	// Helper to format bytes for display
	function formatBytes(bytes) {
		if (bytes === 0) return '0 B';
		const k = 1024;
		const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
	}

	// Function to upload file with progress tracking
	function uploadFile(file) {
		// Best-effort client-side validation based on page load data.
		// Note: Quota may be stale if uploads occur in other tabs/windows.
		// Server-side validation is authoritative; page reloads after successful uploads.
		if (file.size > maxUploadSize) {
			alert('File too large. Maximum size is ' + formatBytes(maxUploadSize) + '.\nYour file: ' + formatBytes(file.size));
			return;
		}

		if (file.size > remainingQuota) {
			alert('Insufficient storage quota.\nFile size: ' + formatBytes(file.size) + '\nRemaining quota: ' + formatBytes(remainingQuota));
			return;
		}

		const formData = new FormData();
		formData.append('file', file);
		formData.append('folder', uploadForm.querySelector('input[name="folder"]').value);
		formData.append('csrf_token', document.getElementById('csrf-token').value);

		// Hide upload button and show progress bar
		uploadButton.classList.add('hidden');
		progressContainer.classList.remove('hidden');
		uploadFilename.textContent = file.name;
		uploadPercentage.textContent = '0%';
		progressFill.style.width = '0%';
		document.getElementById('upload-speed').textContent = 'Speed: calculating...';
		document.getElementById('upload-eta').textContent = 'Time remaining: calculating...';

		// Create XHR for upload with progress tracking
		const xhr = new XMLHttpRequest();
		
		// Variables for speed calculation
		const startTime = Date.now();
		let lastTime = startTime;
		let lastLoaded = 0;

		// Track upload progress
		xhr.upload.addEventListener('progress', function(e) {
			if (e.lengthComputable) {
				const percentage = Math.round((e.loaded / e.total) * 100);
				progressFill.style.width = percentage + '%';
				uploadPercentage.textContent = percentage + '%';

				// Calculate speed and ETA
				const currentTime = Date.now();
				const timeDiff = (currentTime - lastTime) / 1000; // seconds
				const bytesDiff = e.loaded - lastLoaded;

				// Update speed every 500ms to smooth out fluctuations
				if (timeDiff >= 0.5) {
					const speed = bytesDiff / timeDiff; // bytes per second
					const remainingBytes = e.total - e.loaded;
					const eta = speed > 0 ? remainingBytes / speed : 0; // seconds

					// Update UI
					document.getElementById('upload-speed').textContent = 'Speed: ' + formatBytes(speed) + '/s';
					
					if (eta > 0) {
						const etaFormatted = eta < 60 
							? Math.round(eta) + 's' 
							: Math.floor(eta / 60) + 'm ' + Math.round(eta % 60) + 's';
						document.getElementById('upload-eta').textContent = 'Time remaining: ' + etaFormatted;
					} else {
						document.getElementById('upload-eta').textContent = 'Time remaining: calculating...';
					}

					lastTime = currentTime;
					lastLoaded = e.loaded;
				}
			}
		});

		// Handle completion
		xhr.addEventListener('load', function() {
			if (xhr.status === 200 || xhr.status === 302 || xhr.status === 303) {
				// Success - reload page to show updated file list
				window.location.reload();
			} else {
				// Error
				alert('Upload failed. Please try again.');
				progressContainer.classList.add('hidden');
				uploadButton.classList.remove('hidden');
			}
		});

		// Handle errors
		xhr.addEventListener('error', function() {
			alert('Upload failed. Please try again.');
			progressContainer.classList.add('hidden');
			uploadButton.classList.remove('hidden');
		});

		// Note: /upload is exempted from CSRF middleware for streaming and is
		// protected by session authentication and SameSite cookie policy instead.
		xhr.open('POST', '/upload');
		xhr.send(formData);
	}

	// Prevent default drag behaviors on the entire page
	['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
		document.body.addEventListener(eventName, preventDefaults, false);
	});

	function preventDefaults(e) {
		e.preventDefault();
		e.stopPropagation();
	}

	// Show overlay when dragging files over the window
	document.body.addEventListener('dragenter', function(e) {
		if (e.dataTransfer.types.includes('Files')) {
			dragCounter++;
			dragOverlay.classList.remove('hidden');
			dragOverlay.classList.add('flex');
		}
	});

	document.body.addEventListener('dragleave', function(e) {
		dragCounter--;
		if (dragCounter === 0) {
			dragOverlay.classList.add('hidden');
			dragOverlay.classList.remove('flex');
		}
	});

	// Handle file drop
	document.body.addEventListener('drop', function(e) {
		dragCounter = 0;
		dragOverlay.classList.add('hidden');
		dragOverlay.classList.remove('flex');
		
		const files = e.dataTransfer.files;
		if (files.length > 0) {
			uploadFile(files[0]);
		}
	});

	// Also hide overlay when dragging over it
	dragOverlay.addEventListener('dragover', function(e) {
		e.preventDefault();
	});

	// Handle file selection via button
	fileInput.addEventListener('change', function() {
		if (this.files.length > 0) {
			uploadFile(this.files[0]);
		}
	});
</script>

{{end}}
