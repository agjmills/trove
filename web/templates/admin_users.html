{{define "content"}}
{{template "flash_messages" .}}

<!-- Create User Modal -->
<div id="create-user-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="create-user-modal-title">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70 modal-backdrop" data-modal="create-user-modal"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 id="create-user-modal-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100">Create New User</h3>
				<button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none modal-close-btn" data-modal="create-user-modal" aria-label="Close modal">&times;</button>
			</div>
			<form method="POST" action="/admin/users/create">
				
				<div class="mb-4">
					<label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
					<input type="text" id="username" name="username" required
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
				</div>

				<div class="mb-4">
					<label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
					<input type="email" id="email" name="email" required
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
				</div>

				<div class="mb-4">
					<label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Password</label>
					<input type="password" id="password" name="password" required minlength="8"
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
					<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Must be at least 8 characters. User can change this after logging in.</p>
				</div>

				<div class="mb-6">
					<label class="flex items-center gap-2 cursor-pointer">
						<input type="checkbox" name="is_admin" class="w-4 h-4 text-gray-900 dark:text-gray-100 rounded border-gray-300 dark:border-gray-600 focus:ring-gray-900 dark:focus:ring-gray-400">
						<span class="text-sm font-medium text-gray-700 dark:text-gray-300">Make this user an admin</span>
					</label>
				</div>

				<div class="flex gap-3 justify-end">
					<button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors modal-close-btn" data-modal="create-user-modal">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Create User</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Reset Password Modal -->
<div id="reset-password-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="reset-password-modal-title">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70 modal-backdrop" data-modal="reset-password-modal"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 id="reset-password-modal-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100">Reset Password</h3>
				<button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none modal-close-btn" data-modal="reset-password-modal" aria-label="Close modal">&times;</button>
			</div>
			<form id="reset-password-form" method="POST" action="">
				<p id="reset-password-username" class="text-sm text-gray-600 dark:text-gray-400 mb-4"></p>
				
				<div class="mb-6">
					<label for="new_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Password</label>
					<input type="password" id="new_password" name="new_password" required minlength="8"
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
					<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Must be at least 8 characters</p>
				</div>

				<div class="flex gap-3 justify-end">
					<button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors modal-close-btn" data-modal="reset-password-modal">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Reset Password</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Update Quota Modal -->
<div id="update-quota-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="update-quota-modal-title">
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="fixed inset-0 bg-gray-900/50 dark:bg-black/70 modal-backdrop" data-modal="update-quota-modal"></div>
		<div class="relative bg-white dark:bg-gray-800 rounded-lg w-full max-w-md p-6 border-2 border-gray-300 dark:border-gray-600" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
			<div class="flex items-center justify-between mb-4">
				<h3 id="update-quota-modal-title" class="text-lg font-semibold text-gray-900 dark:text-gray-100">Update Storage Quota</h3>
				<button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl leading-none modal-close-btn" data-modal="update-quota-modal" aria-label="Close modal">&times;</button>
			</div>
			<form id="update-quota-form" method="POST" action="">
				<p id="update-quota-username" class="text-sm text-gray-600 dark:text-gray-400 mb-4"></p>
				
				<div class="mb-6">
					<label for="quota" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quota (in bytes)</label>
					<input type="number" id="quota" name="quota" required min="0"
						class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-gray-400">
					<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
						Presets: 
						<button type="button" onclick="setQuota(1073741824)" class="text-blue-600 dark:text-blue-400 hover:underline">1 GB</button> |
						<button type="button" onclick="setQuota(5368709120)" class="text-blue-600 dark:text-blue-400 hover:underline">5 GB</button> |
						<button type="button" onclick="setQuota(10737418240)" class="text-blue-600 dark:text-blue-400 hover:underline">10 GB</button> |
						<button type="button" onclick="setQuota(53687091200)" class="text-blue-600 dark:text-blue-400 hover:underline">50 GB</button> |
						<button type="button" onclick="setQuota(107374182400)" class="text-blue-600 dark:text-blue-400 hover:underline">100 GB</button>
					</p>
				</div>

				<div class="flex gap-3 justify-end">
					<button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors modal-close-btn" data-modal="update-quota-modal">Cancel</button>
					<button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-600 hover:bg-gray-700 dark:hover:bg-gray-500 rounded-lg transition-colors">Update Quota</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="min-h-[calc(100vh-80px)] bg-white dark:bg-gray-800">
	<main class="p-4 sm:p-6 max-w-7xl mx-auto">
		<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
			<div class="flex items-center gap-4">
				<a href="/admin" class="flex items-center justify-center w-8 h-8 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-gray-600 dark:text-gray-400" title="Back to Dashboard">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<polyline points="15 18 9 12 15 6"></polyline>
					</svg>
				</a>
				<h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-gray-100">User Management</h1>
			</div>
			<button id="open-create-user-modal-btn" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gray-900 dark:bg-gray-600 text-white hover:bg-gray-700 dark:hover:bg-gray-500 transition-colors font-medium w-full sm:w-auto">
				<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
					<circle cx="8.5" cy="7" r="4"></circle>
					<line x1="20" y1="8" x2="20" y2="14"></line>
					<line x1="23" y1="11" x2="17" y2="11"></line>
				</svg>
				Add User
			</button>
		</div>

		<!-- Users Table (Desktop) -->
		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 hidden md:block">
			{{if .Users}}
			<div class="overflow-x-auto">
				<table class="w-full border-collapse">
					<thead>
						<tr class="bg-gray-50 dark:bg-gray-700">
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">User</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Role</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Files</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Storage</th>
							<th class="text-left p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Created</th>
							<th class="text-right p-4 text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600">Actions</th>
						</tr>
					</thead>
					<tbody>
						{{range .Users}}
						<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
							<td class="p-4 border-b border-gray-200 dark:border-gray-700">
								<div class="font-medium text-gray-900 dark:text-gray-100">{{.Username}}</div>
								<div class="text-sm text-gray-500 dark:text-gray-400">{{.Email}}</div>
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700">
								{{if .IsAdmin}}
								<span class="px-2 py-1 text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full">Admin</span>
								{{else}}
								<span class="px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full">User</span>
								{{end}}
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">{{.FileCount}}</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">
								{{formatBytes .StorageUsed}} / {{formatBytes .StorageQuota}}
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400">
								{{.CreatedAt.Format "2006-01-02"}}
							</td>
							<td class="p-4 border-b border-gray-200 dark:border-gray-700 text-right">
								<div class="flex items-center justify-end gap-2">
									<!-- Toggle Admin -->
									{{if ne .ID $.User.ID}}
									<form method="POST" action="/admin/users/{{.ID}}/toggle-admin" class="inline">
										<button type="submit" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="{{if .IsAdmin}}Remove Admin{{else}}Make Admin{{end}}">
											{{if .IsAdmin}}
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600 dark:text-purple-400" aria-hidden="true">
												<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
												<polyline points="9 12 12 15 16 10"></polyline>
											</svg>
											{{else}}
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true">
												<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
											</svg>
											{{end}}
										</button>
									</form>
									{{else}}
									<span class="p-2 opacity-40 cursor-not-allowed" title="Cannot modify your own admin status">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600 dark:text-purple-400" aria-hidden="true">
											<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
											<polyline points="9 12 12 15 16 10"></polyline>
										</svg>
									</span>
									{{end}}

									<!-- Update Quota -->
									<button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors update-quota-btn" data-user-id="{{.ID}}" data-username="{{.Username}}" data-quota="{{.StorageQuota}}" title="Update Quota">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-400" aria-hidden="true">
											<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
											<path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
											<path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
										</svg>
									</button>

									<!-- Reset Password -->
									<button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors reset-password-btn" data-user-id="{{.ID}}" data-username="{{.Username}}" title="Reset Password">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-400" aria-hidden="true">
											<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
											<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
										</svg>
									</button>

									<!-- Delete User -->
									{{if ne .ID $.User.ID}}
									<form method="POST" action="/admin/users/{{.ID}}/delete" id="delete-form-{{.ID}}" class="inline">
										<button type="button" class="p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors delete-user-btn" data-user-id="{{.ID}}" data-username="{{.Username}}" data-file-count="{{.FileCount}}" data-storage-used="{{formatBytes .StorageUsed}}" title="Delete User">
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600 dark:text-red-400" aria-hidden="true">
												<polyline points="3 6 5 6 21 6"></polyline>
												<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
											</svg>
										</button>
									</form>
									{{else}}
									<span class="p-2 opacity-40 cursor-not-allowed" title="Cannot delete your own account">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true">
											<polyline points="3 6 5 6 21 6"></polyline>
											<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
										</svg>
									</span>
									{{end}}
								</div>
							</td>
						</tr>
						{{end}}
					</tbody>
				</table>
			</div>
			{{else}}
			<div class="p-8 text-center text-gray-600 dark:text-gray-400">
				<p>No users found.</p>
			</div>
			{{end}}
		</div>

		<!-- Users Cards (Mobile) -->
		<div class="md:hidden space-y-4">
			{{if .Users}}
			{{range .Users}}
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4">
				<!-- User Header -->
				<div class="flex items-start justify-between mb-3">
					<div class="flex-1 min-w-0">
						<div class="flex items-center gap-2 flex-wrap">
							<h3 class="font-medium text-gray-900 dark:text-gray-100 truncate">{{.Username}}</h3>
							{{if .IsAdmin}}
							<span class="px-2 py-0.5 text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full shrink-0">Admin</span>
							{{else}}
							<span class="px-2 py-0.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full shrink-0">User</span>
							{{end}}
						</div>
						<p class="text-sm text-gray-500 dark:text-gray-400 truncate mt-0.5">{{.Email}}</p>
					</div>
				</div>

				<!-- User Stats -->
				<div class="grid grid-cols-3 gap-3 mb-4 text-sm">
					<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-2 text-center">
						<div class="text-gray-500 dark:text-gray-400 text-xs">Files</div>
						<div class="font-medium text-gray-900 dark:text-gray-100">{{.FileCount}}</div>
					</div>
					<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-2 text-center">
						<div class="text-gray-500 dark:text-gray-400 text-xs">Storage</div>
						<div class="font-medium text-gray-900 dark:text-gray-100 text-xs">{{formatBytes .StorageUsed}}</div>
						<div class="text-gray-400 dark:text-gray-500 text-xs">/ {{formatBytes .StorageQuota}}</div>
					</div>
					<div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-2 text-center">
						<div class="text-gray-500 dark:text-gray-400 text-xs">Created</div>
						<div class="font-medium text-gray-900 dark:text-gray-100 text-xs">{{.CreatedAt.Format "Jan 2"}}</div>
						<div class="text-gray-400 dark:text-gray-500 text-xs">{{.CreatedAt.Format "2006"}}</div>
					</div>
				</div>

				<!-- Actions -->
				<div class="flex items-center justify-end gap-1 pt-3 border-t border-gray-200 dark:border-gray-700">
					<!-- Toggle Admin -->
					{{if ne .ID $.User.ID}}
					<form method="POST" action="/admin/users/{{.ID}}/toggle-admin" class="inline">
						<button type="submit" class="p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="{{if .IsAdmin}}Remove Admin{{else}}Make Admin{{end}}">
							{{if .IsAdmin}}
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600 dark:text-purple-400" aria-hidden="true">
								<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
								<polyline points="9 12 12 15 16 10"></polyline>
							</svg>
							{{else}}
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true">
								<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
							</svg>
							{{end}}
						</button>
					</form>
					{{else}}
					<span class="p-2.5 opacity-40 cursor-not-allowed" title="Cannot modify your own admin status">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600 dark:text-purple-400" aria-hidden="true">
							<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
							<polyline points="9 12 12 15 16 10"></polyline>
						</svg>
					</span>
					{{end}}

					<!-- Update Quota -->
					<button class="p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors update-quota-btn" data-user-id="{{.ID}}" data-username="{{.Username}}" data-quota="{{.StorageQuota}}" title="Update Quota">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-400" aria-hidden="true">
							<ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
							<path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
							<path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
						</svg>
					</button>

					<!-- Reset Password -->
					<button class="p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors reset-password-btn" data-user-id="{{.ID}}" data-username="{{.Username}}" title="Reset Password">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-400" aria-hidden="true">
							<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
							<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
						</svg>
					</button>

					<!-- Delete User -->
					{{if ne .ID $.User.ID}}
					<form method="POST" action="/admin/users/{{.ID}}/delete" id="delete-form-mobile-{{.ID}}" class="inline">
						<button type="button" class="p-2.5 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors delete-user-btn" data-user-id="{{.ID}}" data-username="{{.Username}}" data-file-count="{{.FileCount}}" data-storage-used="{{formatBytes .StorageUsed}}" data-mobile="true" title="Delete User">
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600 dark:text-red-400" aria-hidden="true">
								<polyline points="3 6 5 6 21 6"></polyline>
								<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
							</svg>
						</button>
					</form>
					{{else}}
					<span class="p-2.5 opacity-40 cursor-not-allowed" title="Cannot delete your own account">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400" aria-hidden="true">
							<polyline points="3 6 5 6 21 6"></polyline>
							<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
						</svg>
					</span>
					{{end}}
				</div>
			</div>
			{{end}}
			{{else}}
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-8 text-center text-gray-600 dark:text-gray-400">
				<p>No users found.</p>
			</div>
			{{end}}
		</div>
	</main>
</div>

<script>
	// Modal management utilities
	const ModalManager = {
		activeModal: null,
		previouslyFocusedElement: null,

		open: function(modalId, focusElementId) {
			const modal = document.getElementById(modalId);
			if (!modal) return;

			this.previouslyFocusedElement = document.activeElement;
			this.activeModal = modal;
			modal.classList.remove('hidden');
			
			if (focusElementId) {
				const focusElement = document.getElementById(focusElementId);
				if (focusElement) focusElement.focus();
			}

			// Prevent body scroll when modal is open
			document.body.style.overflow = 'hidden';
		},

		close: function(modalId) {
			const modal = document.getElementById(modalId);
			if (!modal) return;

			modal.classList.add('hidden');
			this.activeModal = null;

			// Restore body scroll
			document.body.style.overflow = '';

			// Return focus to the previously focused element
			if (this.previouslyFocusedElement) {
				this.previouslyFocusedElement.focus();
				this.previouslyFocusedElement = null;
			}
		},

		closeActive: function() {
			if (this.activeModal) {
				this.close(this.activeModal.id);
			}
		},

		getFocusableElements: function(modal) {
			return modal.querySelectorAll(
				'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
			);
		},

		trapFocus: function(e) {
			if (!ModalManager.activeModal) return;

			const focusable = ModalManager.getFocusableElements(ModalManager.activeModal);
			if (focusable.length === 0) return;

			const firstFocusable = focusable[0];
			const lastFocusable = focusable[focusable.length - 1];

			if (e.shiftKey && document.activeElement === firstFocusable) {
				e.preventDefault();
				lastFocusable.focus();
			} else if (!e.shiftKey && document.activeElement === lastFocusable) {
				e.preventDefault();
				firstFocusable.focus();
			}
		}
	};

	// Create User Modal
	document.getElementById('open-create-user-modal-btn').addEventListener('click', function() {
		ModalManager.open('create-user-modal', 'username');
	});

	// Reset Password Modal - using event delegation
	document.addEventListener('click', function(e) {
		const resetBtn = e.target.closest('.reset-password-btn');
		if (resetBtn) {
			const userId = resetBtn.dataset.userId;
			const username = resetBtn.dataset.username;
			
			document.getElementById('reset-password-form').action = '/admin/users/' + userId + '/reset-password';
			document.getElementById('reset-password-username').textContent = 'Reset password for: ' + username;
			ModalManager.open('reset-password-modal', 'new_password');
		}
	});

	// Update Quota Modal - using event delegation
	document.addEventListener('click', function(e) {
		const quotaBtn = e.target.closest('.update-quota-btn');
		if (quotaBtn) {
			const userId = quotaBtn.dataset.userId;
			const username = quotaBtn.dataset.username;
			const currentQuota = quotaBtn.dataset.quota;
			
			document.getElementById('update-quota-form').action = '/admin/users/' + userId + '/quota';
			document.getElementById('update-quota-username').textContent = 'Update quota for: ' + username;
			document.getElementById('quota').value = currentQuota;
			ModalManager.open('update-quota-modal', 'quota');
		}
	});

	// Delete User Confirmation - using event delegation
	document.addEventListener('click', function(e) {
		const deleteBtn = e.target.closest('.delete-user-btn');
		if (deleteBtn) {
			const userId = deleteBtn.dataset.userId;
			const username = deleteBtn.dataset.username;
			const fileCount = parseInt(deleteBtn.dataset.fileCount, 10);
			const storageUsed = deleteBtn.dataset.storageUsed;
			const isMobile = deleteBtn.dataset.mobile === 'true';
			
			let message = 'Are you sure you want to delete user "' + username + '"?\n\n';
			
			if (fileCount > 0) {
				message += 'This will permanently delete:\n';
				message += '• ' + fileCount + ' file' + (fileCount !== 1 ? 's' : '') + '\n';
				message += '• ' + storageUsed + ' of storage\n\n';
				
				if (fileCount > 100) {
					message += '⚠️ WARNING: This user has many files. File deletion will happen in the background and may take some time to complete.\n\n';
				}
			} else {
				message += 'This user has no files.\n\n';
			}
			
			message += 'This action cannot be undone.';
			
			if (confirm(message)) {
				const formId = isMobile ? 'delete-form-mobile-' + userId : 'delete-form-' + userId;
				const form = document.getElementById(formId);
				if (form) form.submit();
			}
		}
	});

	// Modal close buttons and backdrop clicks - using event delegation
	document.addEventListener('click', function(e) {
		const closeBtn = e.target.closest('.modal-close-btn');
		if (closeBtn) {
			const modalId = closeBtn.dataset.modal;
			ModalManager.close(modalId);
			clearModalForm(modalId);
		}

		const backdrop = e.target.closest('.modal-backdrop');
		if (backdrop) {
			const modalId = backdrop.dataset.modal;
			ModalManager.close(modalId);
			clearModalForm(modalId);
		}
	});

	// Quota preset buttons
	document.addEventListener('click', function(e) {
		if (e.target.matches('[data-quota-preset]') || e.target.closest('[data-quota-preset]')) {
			const btn = e.target.closest('[data-quota-preset]') || e.target;
			const bytes = btn.dataset.quotaPreset;
			document.getElementById('quota').value = bytes;
		}
	});

	function setQuota(bytes) {
		document.getElementById('quota').value = bytes;
	}

	function clearModalForm(modalId) {
		if (modalId === 'create-user-modal') {
			document.getElementById('username').value = '';
			document.getElementById('email').value = '';
			document.getElementById('password').value = '';
		} else if (modalId === 'reset-password-modal') {
			document.getElementById('new_password').value = '';
		}
	}

	// Close modals on Escape key and trap focus with Tab
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			if (ModalManager.activeModal) {
				clearModalForm(ModalManager.activeModal.id);
				ModalManager.closeActive();
			}
		} else if (e.key === 'Tab') {
			ModalManager.trapFocus(e);
		}
	});
</script>
{{end}}
